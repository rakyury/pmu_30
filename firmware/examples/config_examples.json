{
  "version": "3.0",
  "device": {
    "name": "PMU-30 Racing Controller",
    "serial_number": "PMU30-001",
    "firmware_version": "3.0.0"
  },

  "_comment_can_messages": "CAN message definitions - separate from channel system",
  "can_messages": [
    {
      "name": "msg_ecu_data",
      "can_bus": 1,
      "base_id": 256,
      "is_extended": false,
      "dlc": 8,
      "signals": [
        {"name": "rpm", "start_bit": 0, "length": 16, "byte_order": "little_endian", "value_type": "unsigned", "factor": 1.0, "offset": 0.0},
        {"name": "tps", "start_bit": 16, "length": 8, "byte_order": "little_endian", "value_type": "unsigned", "factor": 0.5, "offset": 0.0},
        {"name": "map", "start_bit": 24, "length": 8, "byte_order": "little_endian", "value_type": "unsigned", "factor": 1.0, "offset": 0.0},
        {"name": "iat", "start_bit": 32, "length": 8, "byte_order": "little_endian", "value_type": "signed", "factor": 1.0, "offset": -40.0}
      ]
    },
    {
      "name": "msg_ecu_temps",
      "can_bus": 1,
      "base_id": 257,
      "is_extended": false,
      "dlc": 8,
      "signals": [
        {"name": "coolant_temp", "start_bit": 0, "length": 8, "byte_order": "little_endian", "value_type": "signed", "factor": 1.0, "offset": -40.0},
        {"name": "oil_temp", "start_bit": 8, "length": 8, "byte_order": "little_endian", "value_type": "signed", "factor": 1.0, "offset": -40.0},
        {"name": "fuel_temp", "start_bit": 16, "length": 8, "byte_order": "little_endian", "value_type": "signed", "factor": 1.0, "offset": -40.0}
      ]
    },
    {
      "name": "msg_pmu_status",
      "can_bus": 1,
      "base_id": 768,
      "is_extended": false,
      "dlc": 8
    }
  ],

  "_comment_channels": "All channels use numeric channel_id (0-99 inputs, 100-199 outputs, 200-999 virtual)",
  "channels": [
    {
      "_comment": "=== DIGITAL INPUTS (0-49) ===",
      "channel_id": 1,
      "channel_type": "digital_input",
      "channel_name": "Ignition",
      "subtype": "switch_active_low",
      "input_pin": 0,
      "enable_pullup": true,
      "threshold_voltage": 2500,
      "debounce_ms": 50
    },
    {
      "channel_id": 2,
      "channel_type": "digital_input",
      "channel_name": "LaunchButton",
      "subtype": "switch_active_high",
      "input_pin": 1,
      "enable_pullup": false,
      "threshold_voltage": 2500,
      "debounce_ms": 50
    },
    {
      "channel_id": 3,
      "channel_type": "digital_input",
      "channel_name": "EngineRPM",
      "subtype": "rpm",
      "input_pin": 2,
      "enable_pullup": false,
      "threshold_voltage": 2500,
      "trigger_edge": "rising",
      "number_of_teeth": 58,
      "multiplier": 1000,
      "divider": 1000,
      "timeout_ms": 1000
    },
    {
      "channel_id": 4,
      "channel_type": "digital_input",
      "channel_name": "WheelSpeed",
      "subtype": "frequency",
      "input_pin": 3,
      "enable_pullup": true,
      "threshold_voltage": 2500,
      "trigger_edge": "rising",
      "multiplier": 100,
      "divider": 1000,
      "timeout_ms": 500
    },

    {
      "_comment": "=== ANALOG INPUTS (50-99) ===",
      "channel_id": 50,
      "channel_type": "analog_input",
      "channel_name": "Throttle",
      "subtype": "linear",
      "input_pin": 0,
      "pullup_option": "1m_down",
      "decimal_places": 1,
      "min_voltage": 500,
      "max_voltage": 4500,
      "min_value": 0,
      "max_value": 1000,
      "units": "%"
    },
    {
      "channel_id": 51,
      "channel_type": "analog_input",
      "channel_name": "BrakePressure",
      "subtype": "linear",
      "input_pin": 1,
      "pullup_option": "1m_down",
      "decimal_places": 0,
      "min_voltage": 500,
      "max_voltage": 4500,
      "min_value": 0,
      "max_value": 200000,
      "units": "kPa"
    },
    {
      "channel_id": 52,
      "channel_type": "analog_input",
      "channel_name": "CoolantTemp",
      "subtype": "calibrated",
      "input_pin": 2,
      "pullup_option": "10k_up",
      "decimal_places": 1,
      "calibration_points": [
        {"voltage": 500, "value": -40000},
        {"voltage": 1000, "value": 0},
        {"voltage": 2000, "value": 40000},
        {"voltage": 3000, "value": 80000},
        {"voltage": 4000, "value": 100000},
        {"voltage": 4500, "value": 120000}
      ],
      "units": "C"
    },
    {
      "channel_id": 53,
      "channel_type": "analog_input",
      "channel_name": "OilTemp",
      "subtype": "calibrated",
      "input_pin": 3,
      "pullup_option": "10k_up",
      "decimal_places": 1,
      "calibration_points": [
        {"voltage": 500, "value": -40000},
        {"voltage": 1000, "value": 0},
        {"voltage": 2000, "value": 50000},
        {"voltage": 3000, "value": 100000},
        {"voltage": 4500, "value": 150000}
      ],
      "units": "C"
    },
    {
      "channel_id": 54,
      "channel_type": "analog_input",
      "channel_name": "OilPressure",
      "subtype": "linear",
      "input_pin": 4,
      "pullup_option": "1m_down",
      "decimal_places": 1,
      "min_voltage": 500,
      "max_voltage": 4500,
      "min_value": 0,
      "max_value": 10000,
      "units": "bar"
    },
    {
      "channel_id": 55,
      "channel_type": "analog_input",
      "channel_name": "MapSelector",
      "subtype": "rotary_switch",
      "input_pin": 5,
      "pullup_option": "10k_down",
      "positions": 6,
      "debounce_ms": 100
    },

    {
      "_comment": "=== POWER OUTPUTS (100-129) ===",
      "channel_id": 100,
      "channel_type": "power_output",
      "channel_name": "FuelPump",
      "pins": [0],
      "source_channel_id": 200,
      "pwm_enabled": false,
      "current_limit_ma": 15000,
      "inrush_current_ma": 30000,
      "inrush_time_ms": 200,
      "retry_count": 3,
      "retry_forever": false
    },
    {
      "channel_id": 101,
      "channel_type": "power_output",
      "channel_name": "IgnitionCut",
      "pins": [1],
      "source_channel_id": 202,
      "pwm_enabled": false,
      "current_limit_ma": 5000,
      "invert": true
    },
    {
      "channel_id": 102,
      "channel_type": "power_output",
      "channel_name": "CoolingFan",
      "pins": [2],
      "source_channel_id": 203,
      "pwm_enabled": true,
      "pwm_frequency": 100,
      "duty_channel_id": 250,
      "soft_start_ms": 500,
      "current_limit_ma": 20000
    },
    {
      "channel_id": 103,
      "channel_type": "power_output",
      "channel_name": "WarningLight",
      "pins": [3],
      "source_channel_id": 207,
      "pwm_enabled": false,
      "current_limit_ma": 2000
    },
    {
      "channel_id": 104,
      "channel_type": "power_output",
      "channel_name": "Headlights",
      "pins": [4, 5],
      "source_channel_id": 1,
      "pwm_enabled": true,
      "pwm_frequency": 1000,
      "default_duty": 1000,
      "soft_start_ms": 100,
      "current_limit_ma": 10000
    },

    {
      "_comment": "=== H-BRIDGES (150-159) ===",
      "channel_id": 150,
      "channel_type": "hbridge",
      "channel_name": "WindowMotor",
      "bridge_number": 0,
      "source_channel_id": 210,
      "mode": "direction",
      "pwm_frequency": 200,
      "soft_start_ms": 100
    },

    {
      "_comment": "=== LOGIC CHANNELS (200-229) ===",
      "channel_id": 200,
      "channel_type": "logic",
      "channel_name": "EngineRunning",
      "operator": "greater_than",
      "input_a_channel_id": 3,
      "threshold": 500000,
      "true_delay_ms": 500,
      "false_delay_ms": 2000
    },
    {
      "channel_id": 201,
      "channel_type": "logic",
      "channel_name": "LaunchArmed",
      "operator": "and",
      "input_a_channel_id": 1,
      "input_b_channel_id": 2
    },
    {
      "channel_id": 202,
      "channel_type": "logic",
      "channel_name": "RPMLimitActive",
      "operator": "greater_than",
      "input_a_channel_id": 3,
      "threshold": 7500000
    },
    {
      "channel_id": 203,
      "channel_type": "logic",
      "channel_name": "FanControl",
      "operator": "hysteresis",
      "input_a_channel_id": 52,
      "upper_value": 90000,
      "lower_value": 80000,
      "polarity": "normal"
    },
    {
      "channel_id": 204,
      "channel_type": "logic",
      "channel_name": "OverheatWarning",
      "operator": "hysteresis",
      "input_a_channel_id": 52,
      "upper_value": 105000,
      "lower_value": 95000,
      "polarity": "normal"
    },
    {
      "channel_id": 205,
      "channel_type": "logic",
      "channel_name": "LowOilPressure",
      "operator": "hysteresis",
      "input_a_channel_id": 54,
      "upper_value": 2000,
      "lower_value": 1000,
      "polarity": "inverted"
    },
    {
      "channel_id": 206,
      "channel_type": "logic",
      "channel_name": "AnyWarning",
      "operator": "or",
      "input_a_channel_id": 204,
      "input_b_channel_id": 205
    },
    {
      "channel_id": 207,
      "channel_type": "logic",
      "channel_name": "WarningFlash",
      "operator": "flash",
      "input_a_channel_id": 206,
      "time_on_ms": 300,
      "time_off_ms": 300
    },
    {
      "channel_id": 208,
      "channel_type": "logic",
      "channel_name": "FuelPumpLatch",
      "operator": "set_reset",
      "set_channel_id": 1,
      "reset_channel_id": 200,
      "default_state": false
    },

    {
      "_comment": "=== NUMBER CHANNELS (230-249) ===",
      "channel_id": 230,
      "channel_type": "number",
      "channel_name": "MaxTemperature",
      "operation": "max",
      "input_channel_ids": [52, 53],
      "decimal_places": 1
    },
    {
      "channel_id": 231,
      "channel_type": "number",
      "channel_name": "ThrottleClamped",
      "operation": "clamp",
      "input_channel_ids": [50],
      "clamp_min": 0,
      "clamp_max": 900,
      "decimal_places": 1
    },
    {
      "channel_id": 232,
      "channel_type": "number",
      "channel_name": "IdleTargetRPM",
      "operation": "constant",
      "value": 850000
    },

    {
      "_comment": "=== TABLE 2D CHANNELS (250-269) ===",
      "channel_id": 250,
      "channel_type": "table_2d",
      "channel_name": "FanPWMCurve",
      "x_axis_channel_id": 52,
      "x_axis_min": 70000,
      "x_axis_max": 110000,
      "x_axis_values": [70000, 80000, 90000, 100000, 110000],
      "output_values": [0, 0, 500, 800, 1000],
      "decimal_places": 0
    },
    {
      "channel_id": 251,
      "channel_type": "table_2d",
      "channel_name": "FuelPressureTarget",
      "x_axis_channel_id": 50,
      "x_axis_min": 0,
      "x_axis_max": 1000,
      "x_axis_values": [0, 250, 500, 750, 1000],
      "output_values": [30000, 35000, 40000, 42000, 45000],
      "decimal_places": 1
    },

    {
      "_comment": "=== FILTER CHANNELS (270-279) ===",
      "channel_id": 270,
      "channel_type": "filter",
      "channel_name": "ThrottleSmooth",
      "filter_type": "moving_avg",
      "input_channel_id": 50,
      "window_size": 10
    },
    {
      "channel_id": 271,
      "channel_type": "filter",
      "channel_name": "BrakeFiltered",
      "filter_type": "low_pass",
      "input_channel_id": 51,
      "time_constant_ms": 50
    },

    {
      "_comment": "=== TIMER CHANNELS (280-289) ===",
      "channel_id": 280,
      "channel_type": "timer",
      "channel_name": "EngineRunTime",
      "start_channel_id": 200,
      "start_edge": "rising",
      "mode": "count_up",
      "max_seconds": 359999
    },

    {
      "_comment": "=== SWITCH CHANNELS (290-299) ===",
      "channel_id": 290,
      "channel_type": "switch",
      "channel_name": "DrivingMode",
      "switch_type": "latching",
      "input_up_channel_id": 2,
      "input_up_edge": "rising",
      "state_min": 0,
      "state_max": 3,
      "state_default": 0
    },

    {
      "_comment": "=== CAN RX CHANNELS (300-349) ===",
      "channel_id": 300,
      "channel_type": "can_rx",
      "channel_name": "ECU_RPM",
      "message_ref": "msg_ecu_data",
      "signal_name": "rpm",
      "timeout_ms": 500
    },
    {
      "channel_id": 301,
      "channel_type": "can_rx",
      "channel_name": "ECU_TPS",
      "message_ref": "msg_ecu_data",
      "signal_name": "tps",
      "timeout_ms": 500
    },
    {
      "channel_id": 302,
      "channel_type": "can_rx",
      "channel_name": "ECU_MAP",
      "message_ref": "msg_ecu_data",
      "signal_name": "map",
      "timeout_ms": 500
    },
    {
      "channel_id": 303,
      "channel_type": "can_rx",
      "channel_name": "ECU_CoolantTemp",
      "message_ref": "msg_ecu_temps",
      "signal_name": "coolant_temp",
      "timeout_ms": 1000
    },

    {
      "_comment": "=== CAN TX CHANNELS (350-399) ===",
      "channel_id": 350,
      "channel_type": "can_tx",
      "channel_name": "PMU_Status",
      "message_ref": "msg_pmu_status",
      "cycle_time_ms": 100,
      "signals": [
        {"source_channel_id": 50, "start_bit": 0, "length": 8, "factor": 100, "offset": 0},
        {"source_channel_id": 51, "start_bit": 8, "length": 8, "factor": 1000, "offset": 0},
        {"source_channel_id": 52, "start_bit": 16, "length": 8, "factor": 1000, "offset": 40000},
        {"source_channel_id": 206, "start_bit": 24, "length": 1, "factor": 1, "offset": 0}
      ]
    },

    {
      "_comment": "=== PID CONTROLLER (400-409) ===",
      "channel_id": 400,
      "channel_type": "pid",
      "channel_name": "IdleControl",
      "input_channel_id": 3,
      "setpoint_channel_id": 232,
      "output_channel_id": 102,
      "kp": 1500,
      "ki": 200,
      "kd": 50,
      "output_min": 0,
      "output_max": 1000,
      "sample_time_ms": 20,
      "enabled_channel_id": 200
    },

    {
      "_comment": "=== LUA SCRIPT (500-509) ===",
      "channel_id": 500,
      "channel_type": "lua_script",
      "channel_name": "CustomLogic",
      "script": "function update()\n  local rpm = channel.get(3)\n  local tps = channel.get(50)\n  if rpm > 6000 and tps > 900 then\n    return 1\n  end\n  return 0\nend",
      "trigger": "periodic",
      "interval_ms": 10,
      "enabled": true
    },

    {
      "_comment": "=== HANDLER (600-609) ===",
      "channel_id": 600,
      "channel_type": "handler",
      "channel_name": "OverheatHandler",
      "trigger_channel_id": 204,
      "trigger_edge": "rising",
      "actions": [
        {"type": "set_output", "channel_id": 102, "value": 1000},
        {"type": "set_output", "channel_id": 103, "value": 1}
      ]
    },

    {
      "_comment": "=== BLINKMARINE KEYPAD (700-709) ===",
      "channel_id": 700,
      "channel_type": "blinkmarine_keypad",
      "channel_name": "SteeringKeypad",
      "keypad_type": 0,
      "can_bus": 2,
      "base_address": 16,
      "buttons": [
        {"index": 0, "name": "Mode", "press_action": "Toggle", "led_source_channel_id": 290},
        {"index": 1, "name": "Launch", "press_action": "Set High", "led_source_channel_id": 201},
        {"index": 2, "name": "Lights", "press_action": "Toggle", "led_source_channel_id": 104},
        {"index": 3, "name": "Fan", "press_action": "Set High", "led_source_channel_id": 203}
      ]
    }
  ],

  "_comment_settings": "Device and bus settings",
  "settings": {
    "can_a": {
      "enabled": true,
      "bitrate": 500000,
      "fd_enabled": false,
      "termination": true
    },
    "can_b": {
      "enabled": true,
      "bitrate": 1000000,
      "fd_enabled": true,
      "termination": true
    },
    "standard_can_stream": {
      "enabled": true,
      "can_bus": 1,
      "base_id": 1792,
      "rate_hz": 50
    },
    "power": {
      "shutdown_delay_ms": 5000,
      "low_voltage_threshold_mv": 10500,
      "high_voltage_threshold_mv": 16000
    },
    "system": {
      "update_rate_hz": 1000,
      "watchdog_timeout_ms": 100,
      "debug_enabled": true
    }
  }
}
