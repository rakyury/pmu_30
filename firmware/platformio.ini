; PlatformIO Project Configuration File for PMU-30
;
; Owner: R2 m-sport
; Target: STM32H743VIT6 or STM32H753VIT6
; Framework: STM32 HAL + FreeRTOS
; Build System: PlatformIO (CMake-based)
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

[platformio]
default_envs = pmu30_debug

[env]
; Common settings for all environments
platform = ststm32
board = nucleo_h743zi  ; Will be customized to PMU-30 board
framework = stm32cube

; Build flags
build_flags =
    -D HAL_MODULE_ENABLED
    -D USE_FULL_LL_DRIVER
    -D USE_HAL_DRIVER
    -D STM32H743xx
    -D ARM_MATH_CM7
    -D __FPU_PRESENT=1
    -D FREERTOS
    ; Optimization flags
    -O2
    -ffunction-sections
    -fdata-sections
    ; Warning flags
    -Wall
    -Wextra
    -Wno-unused-parameter
    ; Include paths
    -I include/
    -I lib/FreeRTOS/include/
    -I lib/Lua/include/
    -I lib/DBC_Parser/include/

; Linker flags
build_unflags =
    -Os

; C11 standard
build_src_flags =
    -std=c11

; Libraries
lib_deps =
    ; FreeRTOS for STM32
    FreeRTOS-Kernel @ ^10.5.1
    ; cJSON for configuration parsing
    cJSON @ ^1.7.17
    ; Lua 5.4 embedded - TODO: Uncomment after testing
    ; eLua/elua @ ^0.9.0
    ; OR use Lua directly: https://github.com/lua/lua.git#v5.4.6
    ; CMSIS-DSP for signal processing
    ; CMSIS-DSP

; Upload protocol
upload_protocol = stlink
debug_tool = stlink

; Monitor settings
monitor_speed = 115200
monitor_flags =
    --eol=CRLF
    --filter=colorize

[env:pmu30_debug]
; Debug build configuration
build_type = debug
build_flags =
    ${env.build_flags}
    -D DEBUG=1
    -D PMU30_LOG_LEVEL=4  ; Verbose logging
    -g3
    -Og  ; Optimize for debugging

[env:pmu30_release]
; Release build configuration
build_type = release
build_flags =
    ${env.build_flags}
    -D NDEBUG
    -D PMU30_LOG_LEVEL=2  ; Warnings and errors only
    -O2
    -flto  ; Link-time optimization

[env:pmu30_test]
; Unit testing environment
platform = native
build_flags =
    -D UNIT_TEST
    -D PMU30_LOG_LEVEL=4
    -std=c11
test_framework = unity
test_build_src = yes

[env:pmu30_emulator]
; Hardware Emulator environment
; Runs firmware on PC without real hardware
; Usage: pio run -e pmu30_emulator && .pio/build/pmu30_emulator/program
platform = native
build_flags =
    -D PMU_EMULATOR
    -D UNIT_TEST
    -D USE_LUA
    -D PMU30_LOG_LEVEL=4
    -std=c11
    -Wall
    -Wextra
    -Wno-unused-parameter
    -Wno-missing-field-initializers
    -I emulator/
    -I include/
    ; Enable pthread for threading support (Linux/macOS)
    -pthread
    ; Link math library
    -lm
    ; Link Lua library (system lua5.4 or lua)
    -llua5.4
build_src_filter =
    ; Emulator core
    +<emulator/>
    +<../emulator/>
    ; Firmware modules (linked with emulated HAL)
    +<src/pmu_adc.c>
    +<src/pmu_can.c>
    +<src/pmu_profet.c>
    +<src/pmu_hbridge.c>
    +<src/pmu_protection.c>
    +<src/pmu_channel.c>
    +<src/pmu_config.c>
    +<src/pmu_protocol.c>
    +<src/pmu_logic.c>
    +<src/pmu_logic_functions.c>
    +<src/pmu_logging.c>
    +<src/pmu_can_stream.c>
    ; JSON config parser (uses cJSON)
    +<src/pmu_config_json.c>
    ; Config storage (uses emulated flash)
    +<src/pmu_config_storage.c>
    ; Lua scripting engine (requires liblua5.4-dev)
    +<src/pmu_lua.c>
    +<src/pmu_lua_api.c>
    ; Exclude hardware-specific files (UI is emulated in emu_ui.c)
    -<src/main.c>
    -<src/pmu_bootloader.c>
    -<src/pmu_flash.c>
    -<src/pmu_spi.c>
    -<src/pmu_ui.c>
    -<hal_stubs.c>
lib_deps =
    cJSON @ ^1.7.17
lib_ignore =
    FreeRTOS-Kernel
extra_scripts =
    pre:scripts/emulator_pre.py

[env:pmu30_nucleo]
; Nucleo-H743ZI development board
; For testing core functionality without custom PMU-30 hardware
; Enabled:  Config parsing, Channels, Logic, Telemetry, UI (via UART), CAN
; Disabled: PROFET outputs, H-Bridge, WiFi/BT, SPI Flash, External sensors
;
; Nucleo-H743ZI has:
;   - 3x User LEDs (LD1-green, LD2-yellow, LD3-red)
;   - 1x User button (B1)
;   - ST-LINK v3 debugger with UART (VCP)
;   - Arduino connectors with ADC/GPIO
;   - FDCAN1/FDCAN2 on Arduino connector
;
platform = ststm32
board = nucleo_h743zi
framework = stm32cube
build_type = debug

build_flags =
    ${env.build_flags}
    -D DEBUG=1
    -D PMU30_LOG_LEVEL=4
    -g3
    -Og
    ; Nucleo-specific flags
    -D PMU_NUCLEO_BOARD
    ; Disable unsupported hardware
    -D PMU_DISABLE_PROFET
    -D PMU_DISABLE_HBRIDGE
    -D PMU_DISABLE_WIFI
    -D PMU_DISABLE_BLUETOOTH
    -D PMU_DISABLE_SPI_FLASH
    -D PMU_DISABLE_EXTERNAL_SENSORS
    -D PMU_DISABLE_BOOTLOADER
    ; Use UART for protocol instead of WiFi
    -D PMU_PROTOCOL_UART
    ; Reduce number of channels for demo
    -D PMU_MAX_OUTPUTS=3
    -D PMU_MAX_INPUTS=6
    -D PMU_MAX_HBRIDGES=0

build_src_filter =
    +<src/>
    -<src/main.c>
    -<src/pmu_bootloader.c>
    -<src/pmu_flash.c>
    -<src/pmu_spi.c>
    -<src/pmu_profet.c>
    -<src/pmu_hbridge.c>
    -<src/pmu_ui.c>
    ; pmu_stubs.c provides stub implementations for disabled modules

; NOTE: Uses main_nucleo.c as entry point (guarded by PMU_NUCLEO_BOARD)

; Hardware configuration for PMU-30
; Custom board definition (to be created in boards/ directory)
;
; Board: PMU-30 Rev A
; MCU: STM32H743VIT6
; Flash: 2MB
; RAM: 1MB (512KB + 512KB)
; Clock: 480MHz (max)
; External RAM: W25Q512JV 512MB SPI Flash
;
; Peripherals:
; - 30x GPIO (PROFET 2 control)
; - 4x H-Bridge PWM outputs
; - 20x ADC inputs (12-bit)
; - 10x DAC outputs (12-bit)
; - 4x CAN (2x CAN FD, 2x CAN 2.0)
; - 1x LIN (UART-based)
; - 1x SPI (external flash)
; - 1x I2C (sensors: accelerometer, gyro, RTC)
; - 1x SDIO (future SD card support)
; - 1x USB HS (configuration/debug)
; - 1x UART (ESP32-C3 WiFi/BT module)
