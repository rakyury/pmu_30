; PlatformIO Project Configuration File for PMU-30
;
; Owner: R2 m-sport
; Target: STM32H743VIT6 or STM32H753VIT6
; Framework: STM32 HAL + FreeRTOS
; Build System: PlatformIO (CMake-based)
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

[platformio]
default_envs = pmu30_debug

[env]
; Minimal common settings

[stm32_base]
; Common settings for STM32 environments
platform = ststm32
board = nucleo_h743zi  ; Will be customized to PMU-30 board
framework = stm32cube

; Build flags
build_flags =
    -D HAL_MODULE_ENABLED
    -D USE_FULL_LL_DRIVER
    -D USE_HAL_DRIVER
    -D STM32H743xx
    -D ARM_MATH_CM7
    -D __FPU_PRESENT=1
    -D FREERTOS
    ; Optimization flags
    -O2
    -ffunction-sections
    -fdata-sections
    ; Warning flags
    -Wall
    -Wextra
    -Wno-unused-parameter
    ; Include paths
    -I include/
    -I ../shared/
    -I ../shared/engine/
    -I lib/FreeRTOS/include/
    -I lib/Lua/include/
    -I lib/DBC_Parser/include/

; Linker flags
build_unflags =
    -Os

; C11 standard
build_src_flags =
    -std=c11

; Libraries
lib_deps =
    ; FreeRTOS for STM32
    FreeRTOS-Kernel @ ^10.5.1
    ; cJSON for configuration parsing
    cJSON @ ^1.7.17
    ; Lua 5.4 embedded - TODO: Uncomment after testing
    ; eLua/elua @ ^0.9.0
    ; OR use Lua directly: https://github.com/lua/lua.git#v5.4.6
    ; CMSIS-DSP for signal processing
    ; CMSIS-DSP

; Upload protocol
upload_protocol = stlink
debug_tool = stlink

; Monitor settings
monitor_speed = 115200
monitor_flags =
    --eol=CRLF
    --filter=colorize

[env:pmu30_debug]
; Debug build configuration
extends = stm32_base
build_type = debug
build_flags =
    ${stm32_base.build_flags}
    -D DEBUG=1
    -D PMU30_LOG_LEVEL=4  ; Verbose logging
    -g3
    -Og  ; Optimize for debugging

[env:pmu30_release]
; Release build configuration
extends = stm32_base
build_type = release
build_flags =
    ${stm32_base.build_flags}
    -D NDEBUG
    -D PMU30_LOG_LEVEL=2  ; Warnings and errors only
    -O2
    -flto  ; Link-time optimization

[env:pmu30_test]
; Unit testing environment
platform = native
build_flags =
    -D UNIT_TEST
    -D PMU30_LOG_LEVEL=4
    -std=c11
test_framework = unity
test_build_src = yes

[env:pmu30_emulator]
; Hardware Emulator environment
; Runs firmware on PC without real hardware
; Usage: pio run -e pmu30_emulator && .pio/build/pmu30_emulator/program
platform = native
build_flags =
    -D PMU_EMULATOR
    -D UNIT_TEST
    -D PMU30_LOG_LEVEL=4
    -std=c11
    -Wall
    -Wextra
    -Wno-unused-parameter
    -Wno-missing-field-initializers
    -I emulator/
    -I include/
    -I ../shared/
    -I ../shared/engine/
    ; Link libraries (ws2_32 added conditionally via scripts/emulator_pre.py)
    -lm
build_src_filter =
    +<*>
    +<../emulator/*>
    +<../../shared/*.c>
    +<../../shared/engine/*.c>
    +<pmu_channel_exec.c>
    -<main.c>
    -<pmu_bootloader.c>
    -<pmu_flash.c>
    -<pmu_spi.c>
    -<pmu_ui.c>
    -<hal_stubs.c>
lib_deps =
    cJSON @ ^1.7.17
lib_ignore =
    FreeRTOS-Kernel
extra_scripts =
    pre:scripts/emulator_pre.py

[env:pmu30_nucleo]
; Nucleo-H743ZI development board
; For testing core functionality without custom PMU-30 hardware
; Enabled:  Config parsing, Channels, Logic, Telemetry, UI (via UART), CAN
; Disabled: PROFET outputs, H-Bridge, WiFi/BT, SPI Flash, External sensors
;
; Nucleo-H743ZI has:
;   - 3x User LEDs (LD1-green, LD2-yellow, LD3-red)
;   - 1x User button (B1)
;   - ST-LINK v3 debugger with UART (VCP)
;   - Arduino connectors with ADC/GPIO
;   - FDCAN1/FDCAN2 on Arduino connector
;
platform = ststm32
board = nucleo_h743zi
framework = stm32cube
build_type = debug

build_flags =
    ${env.build_flags}
    -D DEBUG=1
    -D PMU30_LOG_LEVEL=4
    -g3
    -Og
    ; Nucleo-specific flags
    -D PMU_NUCLEO_BOARD
    ; Disable unsupported hardware
    -D PMU_DISABLE_PROFET
    -D PMU_DISABLE_HBRIDGE
    -D PMU_DISABLE_WIFI
    -D PMU_DISABLE_BLUETOOTH
    -D PMU_DISABLE_SPI_FLASH
    -D PMU_DISABLE_EXTERNAL_SENSORS
    -D PMU_DISABLE_BOOTLOADER
    ; Use UART for protocol instead of WiFi
    -D PMU_PROTOCOL_UART
    ; Reduce number of channels for demo
    -D PMU_MAX_OUTPUTS=3
    -D PMU_MAX_INPUTS=6
    -D PMU_MAX_HBRIDGES=0

build_src_filter =
    +<*>
    -<main.c>
    -<main_nucleo_f446.c>
    -<pmu_bootloader.c>
    -<pmu_flash.c>
    -<pmu_spi.c>
    -<pmu_profet.c>
    -<pmu_hbridge.c>
    -<pmu_ui.c>
    ; main_nucleo.c is the entry point
    ; pmu_stubs.c provides stub implementations for disabled modules

lib_deps =
    cJSON @ ^1.7.17

[env:nucleo_f446re]
; Nucleo-F446RE development board (STM32F446RE)
; For testing logic, CAN integration and debugging without power outputs
;
; Nucleo-F446RE has:
;   - 1x User LED (LD2 - PA5)
;   - 1x User button (B1 - PC13)
;   - ST-LINK v2-1 debugger with UART VCP (USART2: PA2/PA3)
;   - CAN1: PA11 (RX), PA12 (TX) - requires external transceiver
;   - Arduino connectors with ADC/GPIO
;   - 180 MHz Cortex-M4 with FPU
;
platform = ststm32
board = nucleo_f446re
framework = stm32cube
build_type = debug

build_flags =
    ; STM32F4 specific flags
    -D HAL_MODULE_ENABLED
    -D USE_FULL_LL_DRIVER
    -D USE_HAL_DRIVER
    -D STM32F446xx
    -D ARM_MATH_CM4
    -D __FPU_PRESENT=1
    -D FREERTOS
    ; Debug flags
    -D DEBUG=1
    -D PMU30_LOG_LEVEL=4
    -g3
    -Og
    ; Nucleo-F446RE specific
    -D NUCLEO_F446RE
    -D PMU_NUCLEO_BOARD
    ; Disable unsupported hardware
    -D PMU_DISABLE_PROFET
    -D PMU_DISABLE_HBRIDGE
    -D PMU_DISABLE_WIFI
    -D PMU_DISABLE_BLUETOOTH
    -D PMU_DISABLE_SPI_FLASH
    -D PMU_DISABLE_EXTERNAL_SENSORS
    -D PMU_DISABLE_BOOTLOADER
    -D PMU_DISABLE_LUA
    ; Use UART for protocol (USART2 via ST-LINK VCP)
    -D PMU_PROTOCOL_UART
    -D DEBUG_UART=huart2
    ; Reduced channel count for F446 (128KB RAM)
    -D PMU_MAX_OUTPUTS=6
    -D PMU_MAX_INPUTS=5
    -D PMU_MAX_HBRIDGES=0
    ; Reduce channel registry size (default 1024 = ~72KB!)
    -D PMU_CHANNEL_MAX_CHANNELS=64
    ; Include paths
    -I include/
    -I ../shared/
    -I ../shared/engine/
    -I lib/FreeRTOS/include/
    ; Optimization
    -ffunction-sections
    -fdata-sections
    ; Warnings
    -Wall
    -Wextra
    -Wno-unused-parameter
    -Wno-missing-field-initializers

build_src_filter =
    +<main_nucleo_f446.c>
    +<pmu_stubs.c>
    +<pmu_protocol.c>
    +<pmu_config.c>
    ; +<pmu_config_json.c>  ; DEPRECATED: Binary config only, stubs in pmu_stubs.c
    ; +<pmu_json_helpers.c> ; Only used by pmu_config_json.c
    +<pmu_channel.c>
    +<pmu_logic.c>
    ; +<pmu_logic_functions.c>  ; DEPRECATED: replaced by shared/channel_executor
    ; Shared library (Logic Engine)
    +<../../shared/engine/logic.c>
    +<../../shared/engine/math_ops.c>
    +<../../shared/engine/timer.c>
    +<../../shared/engine/counter.c>
    +<../../shared/engine/pid.c>
    +<../../shared/engine/filter.c>
    +<../../shared/engine/table.c>
    +<../../shared/engine/switch.c>
    +<../../shared/engine/hysteresis.c>
    +<../../shared/engine/flipflop.c>
    +<../../shared/channel_config.c>
    +<../../shared/channel_executor.c>
    +<pmu_channel_exec.c>
    +<pmu_led.c>
    +<pmu_protection.c>
    +<pmu_logging.c>
    ; Exclude H7-specific modules (stubs in pmu_stubs.c)
    -<pmu_can.c>
    -<pmu_adc.c>
    -<pmu_profet.c>
    -<pmu_hbridge.c>
    -<pmu_ui.c>
    -<pmu_flash.c>
    -<pmu_bootloader.c>
    -<pmu_spi.c>
    -<pmu_wifi.c>
    -<pmu_bluetooth.c>
    -<pmu_esp32.c>
    -<pmu_lin.c>
    -<pmu_pid.c>
    -<pmu_blinkmarine.c>
    -<pmu_handler.c>
    -<hal_stubs.c>
    -<main.c>
    -<main_nucleo.c>

lib_deps =
    FreeRTOS-Kernel @ ^10.5.1
    ; cJSON is now local in lib/cJSON (without test.c that has conflicting main())

; NOTE: Uses main_nucleo_f446.c as entry point (guarded by NUCLEO_F446RE)

; Hardware configuration for PMU-30
; Custom board definition (to be created in boards/ directory)
;
; Board: PMU-30 Rev A
; MCU: STM32H743VIT6
; Flash: 2MB
; RAM: 1MB (512KB + 512KB)
; Clock: 480MHz (max)
; External RAM: W25Q512JV 512MB SPI Flash
;
; Peripherals:
; - 30x GPIO (PROFET 2 control)
; - 4x H-Bridge PWM outputs
; - 20x ADC inputs (12-bit)
; - 10x DAC outputs (12-bit)
; - 4x CAN (2x CAN FD, 2x CAN 2.0)
; - 1x LIN (UART-based)
; - 1x SPI (external flash)
; - 1x I2C (sensors: accelerometer, gyro, RTC)
; - 1x SDIO (future SD card support)
; - 1x USB HS (configuration/debug)
; - 1x UART (ESP32-C3 WiFi/BT module)
