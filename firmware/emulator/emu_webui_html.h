/**
 * @file emu_webui_html.h
 * @brief Embedded HTML Dashboard for PMU-30 Emulator WebUI
 */

#ifndef EMU_WEBUI_HTML_H
#define EMU_WEBUI_HTML_H

static const char* DASHBOARD_HTML =
"<!DOCTYPE html>\n"
"<html lang=\"en\">\n"
"<head>\n"
"    <meta charset=\"UTF-8\">\n"
"    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n"
"    <title>PMU-30 Emulator - Extended Monitor</title>\n"
"    <style>\n"
"        * { margin: 0; padding: 0; box-sizing: border-box; }\n"
"        body { font-family: 'Segoe UI', sans-serif; background: #1a1a2e; color: #eee; font-size: 13px; }\n"
"        .header { background: #16213e; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #0f0; }\n"
"        .header h1 { font-size: 1.3em; color: #0f0; }\n"
"        .status { display: flex; align-items: center; gap: 10px; }\n"
"        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #f00; }\n"
"        .status-dot.connected { background: #0f0; animation: pulse 2s infinite; }\n"
"        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }\n"
"        .container { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 12px; padding: 15px; }\n"
"        .card { background: #16213e; border-radius: 6px; padding: 12px; overflow: hidden; }\n"
"        .card h2 { font-size: 0.9em; color: #888; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 6px; display: flex; justify-content: space-between; }\n"
"        .card h2 span { color: #0f0; font-size: 0.85em; }\n"
"        /* PROFET Grid */\n"
"        .profet-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; }\n"
"        .profet-ch { background: #0f3460; padding: 6px 2px; border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; }\n"
"        .profet-ch:hover { transform: scale(1.05); z-index: 10; }\n"
"        .profet-ch.on { background: #0a5; }\n"
"        .profet-ch.pwm { background: #085; border: 1px solid #0ff; }\n"
"        .profet-ch.fault { background: #a00; animation: blink 0.5s infinite; }\n"
"        @keyframes blink { 50% { opacity: 0.5; } }\n"
"        .profet-ch .ch-num { font-size: 0.7em; color: #aaa; }\n"
"        .profet-ch .ch-val { font-size: 0.85em; font-weight: bold; }\n"
"        .profet-ch .ch-pwm { font-size: 0.65em; color: #0ff; }\n"
"        /* Tooltip */\n"
"        .tooltip { display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #000; padding: 8px; border-radius: 4px; white-space: nowrap; z-index: 100; font-size: 0.75em; border: 1px solid #0f0; pointer-events: none; }\n"
"        .profet-ch:hover .tooltip { display: block; }\n"
"        /* H-Bridge */\n"
"        .hbridge-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }\n"
"        .hbridge-ch { background: #0f3460; padding: 10px; border-radius: 6px; }\n"
"        .hbridge-ch.active { border: 1px solid #0f0; }\n"
"        .hbridge-ch.fault { background: #500; border: 1px solid #f00; }\n"
"        .hbridge-ch .hb-title { font-weight: bold; color: #0ff; margin-bottom: 5px; }\n"
"        .hbridge-ch .hb-row { display: flex; justify-content: space-between; font-size: 0.8em; padding: 2px 0; }\n"
"        .hbridge-ch .hb-label { color: #888; }\n"
"        .hbridge-ch .hb-val { color: #fff; }\n"
"        .hbridge-ch .hb-val.fwd { color: #0f0; }\n"
"        .hbridge-ch .hb-val.rev { color: #fa0; }\n"
"        .pos-bar { height: 6px; background: #333; border-radius: 3px; margin-top: 5px; overflow: hidden; }\n"
"        .pos-bar .pos-fill { height: 100%; background: #0f0; transition: width 0.1s; }\n"
"        /* Analog Inputs */\n"
"        .analog-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }\n"
"        .analog-ch { background: #0f3460; padding: 6px; border-radius: 4px; cursor: pointer; transition: background 0.2s; }\n"
"        .analog-ch:hover { background: #1a5a8a; }\n"
"        .analog-ch .ain-label { font-size: 0.7em; color: #888; }\n"
"        .analog-ch .ain-val { font-size: 0.95em; font-weight: bold; transition: color 0.2s; }\n"
"        /* Voltage-based colors */\n"
"        .analog-ch.v-zero { background: #1a1a2e; }\n"
"        .analog-ch.v-zero .ain-val { color: #555; }\n"
"        .analog-ch.v-low { background: #2a2510; }\n"
"        .analog-ch.v-low .ain-val { color: #a87; }\n"
"        .analog-ch.v-med { background: #2a3010; }\n"
"        .analog-ch.v-med .ain-val { color: #dc0; }\n"
"        .analog-ch.v-norm { background: #0f3460; }\n"
"        .analog-ch.v-norm .ain-val { color: #0f0; }\n"
"        .analog-ch.v-high { background: #402010; }\n"
"        .analog-ch.v-high .ain-val { color: #f80; }\n"
"        .analog-ch.v-max { background: #401010; }\n"
"        .analog-ch.v-max .ain-val { color: #f22; }\n"
"        .analog-ch input { width: 100%; background: #0a2540; border: 1px solid #0ff; color: #fff; padding: 3px; border-radius: 3px; font-size: 0.85em; }\n"
"        /* Digital Inputs */\n"
"        .di-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px; }\n"
"        .di-ch { background: #1a1a2e; padding: 8px; border-radius: 4px; cursor: pointer; text-align: center; transition: all 0.2s; border: 2px solid transparent; }\n"
"        .di-ch:hover { border-color: #0ff; }\n"
"        .di-ch.di-high { background: #104030; border-color: #0f0; }\n"
"        .di-ch.di-high .di-val { color: #0f0; }\n"
"        .di-ch .di-label { font-size: 0.7em; color: #888; display: block; }\n"
"        .di-ch .di-val { font-size: 1em; font-weight: bold; color: #555; }\n"
"        /* WiFi/Bluetooth Status */\n"
"        .comm-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }\n"
"        .comm-panel { background: #0f3460; padding: 12px; border-radius: 6px; }\n"
"        .comm-panel h3 { font-size: 0.9em; color: #0ff; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }\n"
"        .comm-panel h3 .comm-icon { width: 20px; height: 20px; }\n"
"        .comm-panel .comm-status { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.8em; }\n"
"        .comm-panel .comm-row { display: flex; justify-content: space-between; padding: 3px 0; }\n"
"        .comm-panel .comm-label { color: #888; }\n"
"        .comm-panel .comm-val { color: #fff; font-weight: bold; }\n"
"        .comm-panel .comm-val.online { color: #0f0; }\n"
"        .comm-panel .comm-val.offline { color: #888; }\n"
"        .comm-panel .comm-val.error { color: #f00; }\n"
"        .comm-controls { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }\n"
"        .comm-controls .btn { padding: 5px 10px; font-size: 0.75em; }\n"
"        .comm-indicator { width: 8px; height: 8px; border-radius: 50%; background: #555; display: inline-block; }\n"
"        .comm-indicator.on { background: #0f0; }\n"
"        .comm-indicator.connecting { background: #fa0; animation: pulse 1s infinite; }\n"
"        .comm-indicator.error { background: #f00; }\n"
"        /* LIN Bus Panel */\n"
"        .lin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }\n"
"        .lin-panel { background: #0f3460; padding: 12px; border-radius: 6px; }\n"
"        .lin-panel h3 { font-size: 0.9em; color: #f0a; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }\n"
"        .lin-panel .lin-status { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.8em; }\n"
"        .lin-panel .lin-row { display: flex; justify-content: space-between; padding: 3px 0; }\n"
"        .lin-panel .lin-label { color: #888; }\n"
"        .lin-panel .lin-val { color: #fff; font-weight: bold; }\n"
"        .lin-panel .lin-val.active { color: #0f0; }\n"
"        .lin-panel .lin-val.sleep { color: #888; }\n"
"        .lin-panel .lin-val.error { color: #f00; }\n"
"        .lin-controls { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }\n"
"        .lin-controls .btn { padding: 5px 10px; font-size: 0.75em; }\n"
"        .lin-inject-form { display: grid; grid-template-columns: auto 1fr auto; gap: 6px; margin-top: 10px; }\n"
"        .lin-inject-form label { font-size: 0.75em; color: #888; }\n"
"        .lin-inject-form input, .lin-inject-form select { background: #0a2540; border: 1px solid #444; color: #fff; padding: 5px; border-radius: 3px; font-size: 0.8em; }\n"
"        .lin-data-row { grid-column: 1 / -1; display: flex; gap: 4px; flex-wrap: wrap; }\n"
"        .lin-data-row input { width: 32px; text-align: center; }\n"
"        .lin-history { max-height: 100px; overflow-y: auto; background: #0a0a15; padding: 6px; border-radius: 4px; margin-top: 8px; font-family: monospace; font-size: 0.75em; }\n"
"        .lin-msg { padding: 2px 0; border-bottom: 1px solid #222; }\n"
"        .lin-msg.tx { color: #f0a; }\n"
"        .lin-msg.rx { color: #0ff; }\n"
"        /* System Controls */\n"
"        .sys-controls { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }\n"
"        .sys-ctrl { background: #0f3460; padding: 10px; border-radius: 6px; }\n"
"        .sys-ctrl label { display: block; font-size: 0.8em; color: #888; margin-bottom: 5px; }\n"
"        .sys-ctrl .ctrl-row { display: flex; align-items: center; gap: 10px; }\n"
"        .sys-ctrl input[type=range] { flex: 1; accent-color: #0f0; }\n"
"        .sys-ctrl .ctrl-val { min-width: 60px; text-align: right; color: #0f0; font-weight: bold; }\n"
"        .sys-status { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 10px; }\n"
"        .sys-item { background: #0a2540; padding: 8px; border-radius: 4px; text-align: center; }\n"
"        .sys-item .si-label { font-size: 0.7em; color: #888; }\n"
"        .sys-item .si-val { font-size: 1em; color: #0f0; font-weight: bold; }\n"
"        /* CAN Injection */\n"
"        .can-form { display: grid; grid-template-columns: auto 1fr auto; gap: 8px; align-items: center; }\n"
"        .can-form label { font-size: 0.8em; color: #888; }\n"
"        .can-form input, .can-form select { background: #0a2540; border: 1px solid #444; color: #fff; padding: 6px 8px; border-radius: 4px; }\n"
"        .can-form input:focus, .can-form select:focus { border-color: #0f0; outline: none; }\n"
"        .can-data { grid-column: 1 / -1; display: flex; gap: 4px; flex-wrap: wrap; }\n"
"        .can-data input { width: 40px; text-align: center; }\n"
"        .can-history { max-height: 120px; overflow-y: auto; background: #0a0a15; padding: 8px; border-radius: 4px; margin-top: 8px; font-family: monospace; font-size: 0.8em; }\n"
"        .can-msg { padding: 2px 0; border-bottom: 1px solid #222; }\n"
"        .can-msg.tx { color: #0f0; }\n"
"        .can-msg.rx { color: #0ff; }\n"
"        /* Load Control */\n"
"        .load-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; }\n"
"        .load-ch { background: #0f3460; padding: 5px; border-radius: 4px; text-align: center; cursor: pointer; font-size: 0.75em; }\n"
"        .load-ch:hover { background: #1a5a8a; }\n"
"        .load-ch .ld-num { color: #888; }\n"
"        .load-ch .ld-val { color: #fa0; font-weight: bold; }\n"
"        .load-ch.short { background: #800; }\n"
"        .load-ch.open { background: #080; }\n"
"        .load-presets { display: flex; gap: 8px; margin-bottom: 10px; }\n"
"        .load-presets button { flex: 1; }\n"
"        /* Fault Injection */\n"
"        .fault-form { display: grid; grid-template-columns: 1fr 1fr auto; gap: 8px; }\n"
"        .fault-form select, .fault-form button { padding: 8px; border-radius: 4px; }\n"
"        .fault-list { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 8px; }\n"
"        .fault-tag { background: #800; padding: 4px 8px; border-radius: 4px; font-size: 0.75em; display: flex; align-items: center; gap: 4px; }\n"
"        .fault-tag button { background: none; border: none; color: #fff; cursor: pointer; font-size: 1em; }\n"
"        /* Buttons */\n"
"        .btn { background: #0f3460; color: #fff; border: none; padding: 8px 14px; border-radius: 4px; cursor: pointer; font-size: 0.85em; transition: background 0.2s; }\n"
"        .btn:hover { background: #1a5a8a; }\n"
"        .btn.primary { background: #0a5; }\n"
"        .btn.primary:hover { background: #0b6; }\n"
"        .btn.danger { background: #a00; }\n"
"        .btn.danger:hover { background: #c00; }\n"
"        .btn.warning { background: #c50; }\n"
"        .btn.warning:hover { background: #e60; }\n"
"        .btn.small { padding: 4px 8px; font-size: 0.75em; }\n"
"        /* Log Panel */\n"
"        .log-tabs { display: flex; gap: 5px; margin-bottom: 8px; }\n"
"        .log-tab { padding: 6px 12px; background: #0f3460; border-radius: 4px 4px 0 0; cursor: pointer; font-size: 0.8em; }\n"
"        .log-tab.active { background: #0a2540; color: #0f0; }\n"
"        .log-container { height: 180px; overflow-y: auto; background: #0a0a15; border-radius: 0 4px 4px 4px; padding: 8px; font-family: monospace; font-size: 0.8em; }\n"
"        .log-entry { padding: 2px 0; border-bottom: 1px solid #222; }\n"
"        .log-entry.error { color: #f55; }\n"
"        .log-entry.warning { color: #fa0; }\n"
"        .log-entry.info { color: #5f5; }\n"
"        .log-entry.debug { color: #888; }\n"
"        .log-entry.cmd { color: #0ff; }\n"
"        .log-entry.config { color: #f0f; }\n"
"        /* Wide cards */\n"
"        .card.wide { grid-column: 1 / -1; }\n"
"        .card.half { }\n"
"        /* Modal */\n"
"        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }\n"
"        .modal.show { display: flex; }\n"
"        .modal-content { background: #16213e; padding: 20px; border-radius: 8px; min-width: 300px; max-width: 500px; }\n"
"        .modal-header { display: flex; justify-content: space-between; margin-bottom: 15px; }\n"
"        .modal-header h3 { color: #0f0; }\n"
"        .modal-close { background: none; border: none; color: #fff; font-size: 1.5em; cursor: pointer; }\n"
"    </style>\n"
"</head>\n"
"<body>\n"
"    <div class=\"header\">\n"
"        <h1>PMU-30 Emulator - Extended Monitor</h1>\n"
"        <div class=\"status\">\n"
"            <div class=\"status-dot\" id=\"wsStatus\"></div>\n"
"            <span id=\"wsText\">Disconnected</span>\n"
"        </div>\n"
"    </div>\n"
"    <div class=\"container\">\n"
"        <!-- PROFET Channels -->\n"
"        <div class=\"card wide\">\n"
"            <h2>PROFET Channels <span id=\"profetActiveCount\">0/30 Active</span></h2>\n"
"            <div class=\"profet-grid\" id=\"profetGrid\"></div>\n"
"        </div>\n"
"        \n"
"        <!-- H-Bridge Channels -->\n"
"        <div class=\"card\">\n"
"            <h2>H-Bridge Motors</h2>\n"
"            <div class=\"hbridge-grid\" id=\"hbridgeGrid\"></div>\n"
"        </div>\n"
"        \n"
"        <!-- Analog Inputs -->\n"
"        <div class=\"card\">\n"
"            <h2>Analog Inputs (click to edit)</h2>\n"
"            <div class=\"analog-grid\" id=\"analogGrid\"></div>\n"
"        </div>\n"
"        \n"
"        <!-- Digital Inputs -->\n"
"        <div class=\"card\">\n"
"            <h2>Digital Inputs (click to toggle)</h2>\n"
"            <div class=\"di-grid\" id=\"digitalGrid\"></div>\n"
"        </div>\n"
"        \n"
"        <!-- WiFi/Bluetooth Status -->\n"
"        <div class=\"card\">\n"
"            <h2>Wireless Communication</h2>\n"
"            <div class=\"comm-grid\">\n"
"                <div class=\"comm-panel\" id=\"wifiPanel\">\n"
"                    <h3><span class=\"comm-indicator\" id=\"wifiIndicator\"></span> WiFi</h3>\n"
"                    <div class=\"comm-status\">\n"
"                        <div class=\"comm-row\"><span class=\"comm-label\">State:</span><span class=\"comm-val\" id=\"wifiState\">OFF</span></div>\n"
"                        <div class=\"comm-row\"><span class=\"comm-label\">Mode:</span><span class=\"comm-val\" id=\"wifiMode\">-</span></div>\n"
"                        <div class=\"comm-row\"><span class=\"comm-label\">IP:</span><span class=\"comm-val\" id=\"wifiIP\">0.0.0.0</span></div>\n"
"                        <div class=\"comm-row\"><span class=\"comm-label\">RSSI:</span><span class=\"comm-val\" id=\"wifiRSSI\">-</span></div>\n"
"                        <div class=\"comm-row\"><span class=\"comm-label\">Clients:</span><span class=\"comm-val\" id=\"wifiClients\">0</span></div>\n"
"                    </div>\n"
"                    <div class=\"comm-controls\">\n"
"                        <button class=\"btn small\" id=\"wifiToggleBtn\" onclick=\"toggleWifi()\">Enable</button>\n"
"                        <button class=\"btn small\" id=\"wifiModeBtn\" onclick=\"toggleWifiMode()\">AP Mode</button>\n"
"                    </div>\n"
"                </div>\n"
"                <div class=\"comm-panel\" id=\"btPanel\">\n"
"                    <h3><span class=\"comm-indicator\" id=\"btIndicator\"></span> Bluetooth</h3>\n"
"                    <div class=\"comm-status\">\n"
"                        <div class=\"comm-row\"><span class=\"comm-label\">State:</span><span class=\"comm-val\" id=\"btState\">OFF</span></div>\n"
"                        <div class=\"comm-row\"><span class=\"comm-label\">Mode:</span><span class=\"comm-val\" id=\"btMode\">-</span></div>\n"
"                        <div class=\"comm-row\"><span class=\"comm-label\">MAC:</span><span class=\"comm-val\" id=\"btMAC\">00:00:00:00:00:00</span></div>\n"
"                        <div class=\"comm-row\"><span class=\"comm-label\">Connections:</span><span class=\"comm-val\" id=\"btConnections\">0</span></div>\n"
"                    </div>\n"
"                    <div class=\"comm-controls\">\n"
"                        <button class=\"btn small\" id=\"btToggleBtn\" onclick=\"toggleBluetooth()\">Enable</button>\n"
"                        <button class=\"btn small\" id=\"btModeBtn\" onclick=\"toggleBleMode()\">BLE Mode</button>\n"
"                        <button class=\"btn small\" id=\"btAdvBtn\" onclick=\"toggleBtAdvertise()\">Advertise</button>\n"
"                    </div>\n"
"                </div>\n"
"            </div>\n"
"        </div>\n"
"        \n"
"        <!-- LIN Bus Status -->\n"
"        <div class=\"card\">\n"
"            <h2>LIN Bus <span id=\"linActiveCount\">0/2 Active</span></h2>\n"
"            <div class=\"lin-grid\">\n"
"                <div class=\"lin-panel\" id=\"linPanel0\">\n"
"                    <h3><span class=\"comm-indicator\" id=\"linIndicator0\"></span> LIN 0</h3>\n"
"                    <div class=\"lin-status\">\n"
"                        <div class=\"lin-row\"><span class=\"lin-label\">State:</span><span class=\"lin-val\" id=\"linState0\">OFF</span></div>\n"
"                        <div class=\"lin-row\"><span class=\"lin-label\">Mode:</span><span class=\"lin-val\" id=\"linMode0\">-</span></div>\n"
"                        <div class=\"lin-row\"><span class=\"lin-label\">Baud:</span><span class=\"lin-val\" id=\"linBaud0\">-</span></div>\n"
"                        <div class=\"lin-row\"><span class=\"lin-label\">RX:</span><span class=\"lin-val\" id=\"linRx0\">0</span></div>\n"
"                        <div class=\"lin-row\"><span class=\"lin-label\">TX:</span><span class=\"lin-val\" id=\"linTx0\">0</span></div>\n"
"                        <div class=\"lin-row\"><span class=\"lin-label\">Errors:</span><span class=\"lin-val\" id=\"linErr0\">0</span></div>\n"
"                    </div>\n"
"                    <div class=\"lin-controls\">\n"
"                        <button class=\"btn small\" id=\"linToggle0\" onclick=\"toggleLin(0)\">Enable</button>\n"
"                        <button class=\"btn small\" onclick=\"linWakeup(0)\">Wakeup</button>\n"
"                        <button class=\"btn small\" onclick=\"linSleep(0)\">Sleep</button>\n"
"                    </div>\n"
"                </div>\n"
"                <div class=\"lin-panel\" id=\"linPanel1\">\n"
"                    <h3><span class=\"comm-indicator\" id=\"linIndicator1\"></span> LIN 1</h3>\n"
"                    <div class=\"lin-status\">\n"
"                        <div class=\"lin-row\"><span class=\"lin-label\">State:</span><span class=\"lin-val\" id=\"linState1\">OFF</span></div>\n"
"                        <div class=\"lin-row\"><span class=\"lin-label\">Mode:</span><span class=\"lin-val\" id=\"linMode1\">-</span></div>\n"
"                        <div class=\"lin-row\"><span class=\"lin-label\">Baud:</span><span class=\"lin-val\" id=\"linBaud1\">-</span></div>\n"
"                        <div class=\"lin-row\"><span class=\"lin-label\">RX:</span><span class=\"lin-val\" id=\"linRx1\">0</span></div>\n"
"                        <div class=\"lin-row\"><span class=\"lin-label\">TX:</span><span class=\"lin-val\" id=\"linTx1\">0</span></div>\n"
"                        <div class=\"lin-row\"><span class=\"lin-label\">Errors:</span><span class=\"lin-val\" id=\"linErr1\">0</span></div>\n"
"                    </div>\n"
"                    <div class=\"lin-controls\">\n"
"                        <button class=\"btn small\" id=\"linToggle1\" onclick=\"toggleLin(1)\">Enable</button>\n"
"                        <button class=\"btn small\" onclick=\"linWakeup(1)\">Wakeup</button>\n"
"                        <button class=\"btn small\" onclick=\"linSleep(1)\">Sleep</button>\n"
"                    </div>\n"
"                </div>\n"
"            </div>\n"
"            <!-- LIN Frame Injection -->\n"
"            <div style=\"margin-top: 12px; padding-top: 10px; border-top: 1px solid #333;\">\n"
"                <h3 style=\"font-size: 0.85em; color: #f0a; margin-bottom: 8px;\">LIN Frame Injection</h3>\n"
"                <div class=\"lin-inject-form\">\n"
"                    <label>Bus:</label>\n"
"                    <select id=\"linInjectBus\" style=\"width: 80px;\">\n"
"                        <option value=\"0\">LIN 0</option>\n"
"                        <option value=\"1\">LIN 1</option>\n"
"                    </select>\n"
"                    <button class=\"btn small primary\" onclick=\"sendLinFrame()\">Inject</button>\n"
"                    <label>ID (0-63):</label>\n"
"                    <input type=\"number\" id=\"linInjectId\" value=\"16\" min=\"0\" max=\"63\" style=\"width: 60px;\">\n"
"                    <span></span>\n"
"                    <div class=\"lin-data-row\">\n"
"                        <label style=\"width:100%%\">Data (hex, 1-8 bytes):</label>\n"
"                        <input type=\"text\" id=\"linD0\" value=\"00\" maxlength=\"2\">\n"
"                        <input type=\"text\" id=\"linD1\" value=\"00\" maxlength=\"2\">\n"
"                        <input type=\"text\" id=\"linD2\" value=\"00\" maxlength=\"2\">\n"
"                        <input type=\"text\" id=\"linD3\" value=\"00\" maxlength=\"2\">\n"
"                        <input type=\"text\" id=\"linD4\" value=\"00\" maxlength=\"2\">\n"
"                        <input type=\"text\" id=\"linD5\" value=\"00\" maxlength=\"2\">\n"
"                        <input type=\"text\" id=\"linD6\" value=\"00\" maxlength=\"2\">\n"
"                        <input type=\"text\" id=\"linD7\" value=\"00\" maxlength=\"2\">\n"
"                    </div>\n"
"                </div>\n"
"                <div class=\"lin-history\" id=\"linHistory\"></div>\n"
"            </div>\n"
"        </div>\n"
"        \n"
"        <!-- System Controls -->\n"
"        <div class=\"card\">\n"
"            <h2>System Controls</h2>\n"
"            <div class=\"sys-controls\">\n"
"                <div class=\"sys-ctrl\">\n"
"                    <label>Battery Voltage</label>\n"
"                    <div class=\"ctrl-row\">\n"
"                        <input type=\"range\" id=\"battVoltage\" min=\"6\" max=\"18\" step=\"0.1\" value=\"12\">\n"
"                        <span class=\"ctrl-val\" id=\"battVoltageVal\">12.0V</span>\n"
"                    </div>\n"
"                </div>\n"
"                <div class=\"sys-ctrl\">\n"
"                    <label>Board Temperature</label>\n"
"                    <div class=\"ctrl-row\">\n"
"                        <input type=\"range\" id=\"boardTemp\" min=\"-20\" max=\"100\" step=\"1\" value=\"25\">\n"
"                        <span class=\"ctrl-val\" id=\"boardTempVal\">25C</span>\n"
"                    </div>\n"
"                </div>\n"
"            </div>\n"
"            <div class=\"sys-status\" id=\"sysStatus\"></div>\n"
"        </div>\n"
"        \n"
"        <!-- Load Simulation -->\n"
"        <div class=\"card\">\n"
"            <h2>Load Simulation (Resistance)</h2>\n"
"            <div class=\"load-presets\">\n"
"                <button class=\"btn small\" onclick=\"setAllLoads(10)\">All Normal (10R)</button>\n"
"                <button class=\"btn small danger\" onclick=\"setAllLoads(0.01)\">All Short (0.01R)</button>\n"
"                <button class=\"btn small\" onclick=\"setAllLoads(10000)\">All Open (10kR)</button>\n"
"            </div>\n"
"            <div class=\"load-grid\" id=\"loadGrid\"></div>\n"
"        </div>\n"
"        \n"
"        <!-- CAN Injection -->\n"
"        <div class=\"card\">\n"
"            <h2>CAN Message Injection</h2>\n"
"            <div class=\"can-form\">\n"
"                <label>Bus:</label>\n"
"                <select id=\"canBus\">\n"
"                    <option value=\"0\">CAN 0</option>\n"
"                    <option value=\"1\">CAN 1</option>\n"
"                    <option value=\"2\">CAN 2</option>\n"
"                    <option value=\"3\">CAN 3</option>\n"
"                </select>\n"
"                <button class=\"btn primary\" onclick=\"sendCanMessage()\">Send</button>\n"
"                <label>ID (hex):</label>\n"
"                <input type=\"text\" id=\"canId\" value=\"100\" placeholder=\"0x100\">\n"
"                <span></span>\n"
"                <div class=\"can-data\">\n"
"                    <label style=\"width:100%\">Data (hex bytes):</label>\n"
"                    <input type=\"text\" id=\"canD0\" value=\"00\" maxlength=\"2\">\n"
"                    <input type=\"text\" id=\"canD1\" value=\"00\" maxlength=\"2\">\n"
"                    <input type=\"text\" id=\"canD2\" value=\"00\" maxlength=\"2\">\n"
"                    <input type=\"text\" id=\"canD3\" value=\"00\" maxlength=\"2\">\n"
"                    <input type=\"text\" id=\"canD4\" value=\"00\" maxlength=\"2\">\n"
"                    <input type=\"text\" id=\"canD5\" value=\"00\" maxlength=\"2\">\n"
"                    <input type=\"text\" id=\"canD6\" value=\"00\" maxlength=\"2\">\n"
"                    <input type=\"text\" id=\"canD7\" value=\"00\" maxlength=\"2\">\n"
"                </div>\n"
"            </div>\n"
"            <div class=\"can-history\" id=\"canHistory\"></div>\n"
"        </div>\n"
"        \n"
"        <!-- Link ECU CAN Stream -->\n"
"        <div class=\"card wide\">\n"
"            <h2>Link ECU Generic Dashboard Stream <span id=\"linkStreamStatus\">Stopped</span></h2>\n"
"            <div style=\"display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-bottom:10px\">\n"
"                <div class=\"sys-ctrl\"><label>RPM</label><input type=\"number\" id=\"linkRpm\" value=\"3500\" min=\"0\" max=\"15000\"></div>\n"
"                <div class=\"sys-ctrl\"><label>TPS %</label><input type=\"number\" id=\"linkTps\" value=\"25\" min=\"0\" max=\"100\" step=\"0.1\"></div>\n"
"                <div class=\"sys-ctrl\"><label>MAP kPa</label><input type=\"number\" id=\"linkMap\" value=\"100\" min=\"0\" max=\"400\"></div>\n"
"                <div class=\"sys-ctrl\"><label>CLT C</label><input type=\"number\" id=\"linkClt\" value=\"85\" min=\"-40\" max=\"150\"></div>\n"
"                <div class=\"sys-ctrl\"><label>IAT C</label><input type=\"number\" id=\"linkIat\" value=\"35\" min=\"-40\" max=\"150\"></div>\n"
"                <div class=\"sys-ctrl\"><label>Battery V</label><input type=\"number\" id=\"linkBatt\" value=\"13.8\" min=\"0\" max=\"20\" step=\"0.1\"></div>\n"
"                <div class=\"sys-ctrl\"><label>Lambda 1</label><input type=\"number\" id=\"linkLambda1\" value=\"1.00\" min=\"0.5\" max=\"2\" step=\"0.01\"></div>\n"
"                <div class=\"sys-ctrl\"><label>Lambda 2</label><input type=\"number\" id=\"linkLambda2\" value=\"1.00\" min=\"0.5\" max=\"2\" step=\"0.01\"></div>\n"
"                <div class=\"sys-ctrl\"><label>Oil P bar</label><input type=\"number\" id=\"linkOilP\" value=\"4.5\" min=\"0\" max=\"10\" step=\"0.1\"></div>\n"
"                <div class=\"sys-ctrl\"><label>Oil T C</label><input type=\"number\" id=\"linkOilT\" value=\"95\" min=\"-40\" max=\"150\"></div>\n"
"                <div class=\"sys-ctrl\"><label>Fuel P bar</label><input type=\"number\" id=\"linkFuelP\" value=\"3.0\" min=\"0\" max=\"10\" step=\"0.1\"></div>\n"
"                <div class=\"sys-ctrl\"><label>Speed km/h</label><input type=\"number\" id=\"linkSpeed\" value=\"120\" min=\"0\" max=\"400\"></div>\n"
"                <div class=\"sys-ctrl\"><label>Gear</label><input type=\"number\" id=\"linkGear\" value=\"4\" min=\"0\" max=\"8\"></div>\n"
"                <div class=\"sys-ctrl\"><label>Ign Angle</label><input type=\"number\" id=\"linkIgn\" value=\"28\" min=\"-20\" max=\"60\" step=\"0.1\"></div>\n"
"                <div class=\"sys-ctrl\"><label>Inj DC %</label><input type=\"number\" id=\"linkInjDC\" value=\"35\" min=\"0\" max=\"100\" step=\"0.1\"></div>\n"
"                <div class=\"sys-ctrl\"><label>Baro kPa</label><input type=\"number\" id=\"linkBaro\" value=\"101\" min=\"80\" max=\"110\"></div>\n"
"            </div>\n"
"            <div style=\"display:flex;gap:8px;flex-wrap:wrap\">\n"
"                <div class=\"sys-ctrl\" style=\"flex:1;min-width:150px\"><label>CAN Bus</label><select id=\"linkCanBus\"><option value=\"0\">CAN 0</option><option value=\"1\" selected>CAN 1</option><option value=\"2\">CAN 2</option><option value=\"3\">CAN 3</option></select></div>\n"
"                <div class=\"sys-ctrl\" style=\"flex:1;min-width:150px\"><label>Base ID (hex)</label><input type=\"text\" id=\"linkBaseId\" value=\"3E8\"></div>\n"
"                <div class=\"sys-ctrl\" style=\"flex:1;min-width:150px\"><label>Interval ms</label><input type=\"number\" id=\"linkInterval\" value=\"50\" min=\"10\" max=\"1000\"></div>\n"
"                <button class=\"btn primary\" id=\"linkStartBtn\" onclick=\"toggleLinkStream()\">Start Stream</button>\n"
"                <button class=\"btn\" onclick=\"sendLinkFrameOnce()\">Send Once</button>\n"
"            </div>\n"
"        </div>\n"
"        \n"
"        <!-- Config Statistics -->\n"
"        <div class=\"card\">\n"
"            <h2>Configuration <span id=\"configStatusBadge\" class=\"badge off\">Not loaded</span></h2>\n"
"            <div id=\"configStats\" style=\"font-size:0.9em\">\n"
"                <div style=\"color:#888\">No configuration loaded</div>\n"
"            </div>\n"
"            <div style=\"margin-top:10px;display:flex;gap:8px;flex-wrap:wrap\">\n"
"                <a id=\"configDownloadLink\" class=\"btn small\" style=\"display:none\" href=\"/config.json\" download=\"pmu30_config.json\">Download</a>\n"
"                <button class=\"btn small\" onclick=\"refreshConfigStats()\">Refresh</button>\n"
"                <button class=\"btn small danger\" onclick=\"clearConfig()\">Clear Config</button>\n"
"            </div>\n"
"            <div style=\"margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;border-top:1px solid #333;padding-top:10px\">\n"
"                <span style=\"color:#888;font-size:0.85em;line-height:28px;\">Emulator State:</span>\n"
"                <button class=\"btn small primary\" onclick=\"saveState()\" title=\"Ctrl+S\">Save State</button>\n"
"                <button class=\"btn small\" onclick=\"loadState()\" title=\"Ctrl+L\">Load State</button>\n"
"            </div>\n"
"            <div style=\"margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;border-top:1px solid #333;padding-top:10px\">\n"
"                <span style=\"color:#888;font-size:0.85em;line-height:28px;\">Device Control:</span>\n"
"                <button class=\"btn small warning\" onclick=\"restartDevice()\" title=\"Restart PMU-30\">Restart Device</button>\n"
"            </div>\n"
"        </div>\n"
"        \n"
"        <!-- Fault Injection -->\n"
"        <div class=\"card\">\n"
"            <h2>Fault Injection</h2>\n"
"            <div class=\"fault-form\">\n"
"                <select id=\"faultChannel\">\n"
"                    <optgroup label=\"PROFET\"></optgroup>\n"
"                </select>\n"
"                <select id=\"faultType\">\n"
"                    <option value=\"1\">Overcurrent</option>\n"
"                    <option value=\"2\">Short Circuit</option>\n"
"                    <option value=\"4\">Open Load</option>\n"
"                    <option value=\"8\">Overtemperature</option>\n"
"                </select>\n"
"                <button class=\"btn danger\" onclick=\"injectFault()\">Inject</button>\n"
"            </div>\n"
"            <div class=\"fault-list\" id=\"faultList\"></div>\n"
"        </div>\n"
"        \n"
"        <!-- Log Panel -->\n"
"        <div class=\"card wide\">\n"
"            <h2>System Logs</h2>\n"
"            <div class=\"log-tabs\">\n"
"                <div class=\"log-tab active\" data-log=\"all\" onclick=\"switchLogTab('all')\">All</div>\n"
"                <div class=\"log-tab\" data-log=\"cmd\" onclick=\"switchLogTab('cmd')\">Commands</div>\n"
"                <div class=\"log-tab\" data-log=\"config\" onclick=\"switchLogTab('config')\">Config</div>\n"
"                <div class=\"log-tab\" data-log=\"error\" onclick=\"switchLogTab('error')\">Errors</div>\n"
"            </div>\n"
"            <div class=\"log-container\" id=\"logContainer\"></div>\n"
"        </div>\n"
"    </div>\n"
"    \n"
"    <!-- Load Edit Modal -->\n"
"    <div class=\"modal\" id=\"loadModal\">\n"
"        <div class=\"modal-content\">\n"
"            <div class=\"modal-header\">\n"
"                <h3>Set Load Resistance - CH<span id=\"loadModalCh\">1</span></h3>\n"
"                <button class=\"modal-close\" onclick=\"closeLoadModal()\">&times;</button>\n"
"            </div>\n"
"            <div style=\"margin-bottom:15px\">\n"
"                <label>Resistance (Ohms):</label>\n"
"                <input type=\"number\" id=\"loadModalValue\" value=\"10\" min=\"0.001\" max=\"100000\" step=\"0.1\" style=\"width:100%;padding:8px;margin-top:5px;background:#0a2540;border:1px solid #444;color:#fff;border-radius:4px\">\n"
"            </div>\n"
"            <div style=\"display:flex;gap:8px\">\n"
"                <button class=\"btn\" onclick=\"setLoadValue(0.01)\">Short (0.01R)</button>\n"
"                <button class=\"btn\" onclick=\"setLoadValue(10)\">Normal (10R)</button>\n"
"                <button class=\"btn\" onclick=\"setLoadValue(10000)\">Open (10kR)</button>\n"
"                <button class=\"btn primary\" onclick=\"applyLoadModal()\">Apply</button>\n"
"            </div>\n"
"        </div>\n"
"    </div>\n"
"    \n"
"    <script>\n"
"        let ws = null;\n"
"        let reconnectTimer = null;\n"
"        let reconnectAttempts = 0;\n"
"        const RECONNECT_BASE_DELAY = 1000;  // 1 second\n"
"        const RECONNECT_MAX_DELAY = 30000;  // 30 seconds max\n"
"        let currentLogFilter = 'all';\n"
"        let telemetryData = {};\n"
"        let loadValues = new Array(30).fill(10);\n"
"        let editingAnalog = -1;\n"
"        let selectedLoadCh = 0;\n"
"        let activeFaults = [];\n"
"        \n"
"        const wsStatus = document.getElementById('wsStatus');\n"
"        const wsText = document.getElementById('wsText');\n"
"        \n"
"        function getReconnectDelay() {\n"
"            // Exponential backoff: 1s, 2s, 4s, 8s, 16s, 30s max\n"
"            const delay = Math.min(RECONNECT_BASE_DELAY * Math.pow(2, reconnectAttempts), RECONNECT_MAX_DELAY);\n"
"            return delay;\n"
"        }\n"
"        \n"
"        function connect() {\n"
"            console.log('[WS] connect() called, attempts:', reconnectAttempts);\n"
"            if (reconnectTimer) {\n"
"                clearTimeout(reconnectTimer);\n"
"                reconnectTimer = null;\n"
"            }\n"
"            \n"
"            wsText.textContent = 'Connecting...';\n"
"            const wsUrl = `ws://${location.host}/ws`;\n"
"            console.log('[WS] Connecting to:', wsUrl);\n"
"            \n"
"            try {\n"
"                ws = new WebSocket(wsUrl);\n"
"            } catch (e) {\n"
"                console.error('[WS] WebSocket creation failed:', e);\n"
"                scheduleReconnect();\n"
"                return;\n"
"            }\n"
"            \n"
"            ws.onopen = () => {\n"
"                console.log('[WS] Connected successfully');\n"
"                reconnectAttempts = 0;  // Reset on successful connection\n"
"                wsStatus.classList.add('connected');\n"
"                wsText.textContent = 'Connected';\n"
"                addLog('info', 'system', 'WebSocket connected');\n"
"                // Request current state on connect\n"
"                console.log('[WS] Requesting initial state...');\n"
"                sendCommand({action: 'get_state'});\n"
"            };\n"
"            \n"
"            ws.onclose = (e) => {\n"
"                console.log('[WS] Connection closed, code:', e.code, 'reason:', e.reason);\n"
"                wsStatus.classList.remove('connected');\n"
"                wsText.textContent = 'Disconnected';\n"
"                if (e.code !== 1000) {  // Not a normal close\n"
"                    console.log('[WS] Scheduling reconnect...');\n"
"                    scheduleReconnect();\n"
"                }\n"
"            };\n"
"            \n"
"            ws.onerror = (e) => {\n"
"                console.error('[WS] Error:', e);\n"
"                addLog('error', 'system', 'WebSocket error');\n"
"            };\n"
"            \n"
"            ws.onmessage = (e) => {\n"
"                try {\n"
"                    handleMessage(JSON.parse(e.data));\n"
"                } catch (err) {\n"
"                    console.error('Failed to parse message:', e.data);\n"
"                }\n"
"            };\n"
"        }\n"
"        \n"
"        function scheduleReconnect() {\n"
"            if (reconnectTimer) return;  // Already scheduled\n"
"            \n"
"            const delay = getReconnectDelay();\n"
"            reconnectAttempts++;\n"
"            \n"
"            wsText.textContent = `Reconnecting in ${(delay/1000).toFixed(0)}s...`;\n"
"            addLog('warning', 'system', `WebSocket disconnected, reconnecting in ${(delay/1000).toFixed(0)}s (attempt ${reconnectAttempts})`);\n"
"            \n"
"            reconnectTimer = setTimeout(() => {\n"
"                reconnectTimer = null;\n"
"                connect();\n"
"            }, delay);\n"
"        }\n"
"        \n"
"        let debugTelemetry = false;  // Set to true to log telemetry data\n"
"        \n"
"        function handleMessage(msg) {\n"
"            if (msg.type === 'telemetry') {\n"
"                if (debugTelemetry) console.log('[MSG] Telemetry received, profets:', msg.data?.profets?.length);\n"
"                telemetryData = msg.data;\n"
"                updateTelemetry(msg.data);\n"
"            } else if (msg.type === 'log') {\n"
"                console.log('[MSG] Log:', msg.level, msg.source, msg.message);\n"
"                addLog(msg.level, msg.source, msg.message);\n"
"            } else if (msg.type === 'can_tx') {\n"
"                console.log('[MSG] CAN TX:', msg.bus, msg.id?.toString(16));\n"
"                addCanHistory('tx', msg.bus, msg.id, msg.data);\n"
"            } else if (msg.type === 'can_rx') {\n"
"                console.log('[MSG] CAN RX:', msg.bus, msg.id?.toString(16));\n"
"                addCanHistory('rx', msg.bus, msg.id, msg.data);\n"
"            } else {\n"
"                console.log('[MSG] Unknown message type:', msg.type, msg);\n"
"            }\n"
"        }\n"
"        \n"
"        function updateTelemetry(data) {\n"
"            // Skip grid update while modal is open to prevent interference\n"
"            const modalOpen = document.getElementById('channelModal').classList.contains('show');\n"
"            \n"
"            // Update PROFET channels (update existing elements, not innerHTML)\n"
"            let activeCount = 0;\n"
"            for (let i = 0; i < 30; i++) {\n"
"                const chDiv = document.getElementById('profet-ch-' + i);\n"
"                if (!chDiv) continue;\n"
"                const ch = data.profets?.[i] || {};\n"
"                const state = ch.state || 0;\n"
"                /* ECUMaster states: 0=OFF, 1=ON, 2=OC, 3=OT, 4=SC, 5=OL, 6=PWM, 7=DIS */\n"
"                const isPwm = state === 6;\n"
"                const isFault = state >= 2 && state <= 5;\n"
"                const isOn = state === 1 || state === 6;\n"
"                if (isOn) activeCount++;\n"
"                \n"
"                // Update classes\n"
"                chDiv.className = 'profet-ch' + (isFault ? ' fault' : (isPwm ? ' pwm' : (isOn ? ' on' : '')));\n"
"                \n"
"                const current = (ch.current || 0).toFixed(1);\n"
"                const pwmPct = ((ch.pwm_duty || 0) / 10).toFixed(0);\n"
"                const temp = ch.temp || 25;\n"
"                const faultStr = getFaultString(ch.fault || 0);\n"
"                \n"
"                // Update values\n"
"                chDiv.querySelector('.ch-val').textContent = current + 'A';\n"
"                const pwmEl = chDiv.querySelector('.ch-pwm');\n"
"                if (isPwm) {\n"
"                    pwmEl.textContent = pwmPct + '%';\n"
"                    pwmEl.style.display = '';\n"
"                } else {\n"
"                    pwmEl.style.display = 'none';\n"
"                }\n"
"                \n"
"                // Update tooltip\n"
"                const tooltip = chDiv.querySelector('.tooltip');\n"
"                tooltip.innerHTML = '<b>Channel ' + (i+1) + '</b><br>' +\n"
"                    'State: ' + ['OFF','ON','OC','OT','SC','OL','PWM','DIS'][state] + '<br>' +\n"
"                    'Current: ' + current + 'A<br>' +\n"
"                    'PWM: ' + pwmPct + '%<br>' +\n"
"                    'Temp: ' + temp + 'C<br>' +\n"
"                    'Load: ' + loadValues[i] + 'R' +\n"
"                    (faultStr ? '<br><span style=\"color:#f55\">Fault: ' + faultStr + '</span>' : '');\n"
"            }\n"
"            document.getElementById('profetActiveCount').textContent = activeCount + '/30 Active';\n"
"            \n"
"            // Update H-Bridge channels (differential - update only values)\n"
"            for (let i = 0; i < 4; i++) {\n"
"                const ch = data.hbridges?.[i] || {};\n"
"                const mode = ch.mode || 0;\n"
"                const state = ch.state || 0;\n"
"                const isFault = ch.fault > 0;\n"
"                const isActive = ch.pwm > 0;\n"
"                const pos = ch.position || 0;\n"
"                const current = (ch.current || 0).toFixed(2);\n"
"                const omega = ch.omega || 0;\n"
"                const backEmf = ch.backEmf || 0;\n"
"                const torque = ch.torque || 0;\n"
"                const temp = ch.temp || 25;\n"
"                const stalled = ch.stalled || 0;\n"
"                const endstop = ch.endstop || 0;\n"
"                \n"
"                const modeStr = ['COAST','FWD','REV','BRAKE','PARK','PID'][mode] || 'UNK';\n"
"                let stateStr = ['IDLE','RUN','PARKING','PARKED','FAULT'][state] || 'UNK';\n"
"                if (stalled) stateStr = 'STALL';\n"
"                if (endstop === 1) stateStr = 'MIN';\n"
"                if (endstop === 2) stateStr = 'MAX';\n"
"                const dirClass = mode === 1 ? 'fwd' : (mode === 2 ? 'rev' : '');\n"
"                \n"
"                // Update container class\n"
"                const hbDiv = document.getElementById('hbridge-ch-' + i);\n"
"                if (hbDiv) {\n"
"                    hbDiv.className = 'hbridge-ch' + (isFault ? ' fault' : (stalled ? ' fault' : (isActive ? ' active' : '')));\n"
"                }\n"
"                \n"
"                // Update individual values\n"
"                const modeEl = document.getElementById('hb-mode-' + i);\n"
"                if (modeEl) { modeEl.textContent = modeStr; modeEl.className = 'hb-val ' + dirClass; }\n"
"                const stateEl = document.getElementById('hb-state-' + i);\n"
"                if (stateEl) stateEl.textContent = stateStr;\n"
"                const pwmEl = document.getElementById('hb-pwm-' + i);\n"
"                if (pwmEl) pwmEl.textContent = (ch.pwm || 0) + '%';\n"
"                const currEl = document.getElementById('hb-curr-' + i);\n"
"                if (currEl) currEl.textContent = current + 'A';\n"
"                const posEl = document.getElementById('hb-pos-' + i);\n"
"                if (posEl) posEl.textContent = (pos/10).toFixed(1) + '%';\n"
"                const barEl = document.getElementById('hb-bar-' + i);\n"
"                if (barEl) barEl.style.width = (pos/10) + '%';\n"
"                // Motor physics values\n"
"                const omegaEl = document.getElementById('hb-omega-' + i);\n"
"                if (omegaEl) omegaEl.textContent = omega.toFixed(1) + ' rad/s';\n"
"                const bemfEl = document.getElementById('hb-bemf-' + i);\n"
"                if (bemfEl) bemfEl.textContent = backEmf.toFixed(1) + 'V';\n"
"                const torqueEl = document.getElementById('hb-torque-' + i);\n"
"                if (torqueEl) torqueEl.textContent = torque.toFixed(3) + ' Nm';\n"
"                const tempEl = document.getElementById('hb-temp-' + i);\n"
"                if (tempEl) { tempEl.textContent = temp.toFixed(0) + 'C'; tempEl.style.color = temp > 80 ? '#f55' : (temp > 50 ? '#fa0' : '#fff'); }\n"
"                // Fault display\n"
"                const faultRow = document.getElementById('hb-fault-row-' + i);\n"
"                const faultEl = document.getElementById('hb-fault-' + i);\n"
"                if (faultRow && faultEl) {\n"
"                    if (isFault) {\n"
"                        faultRow.style.display = '';\n"
"                        faultEl.textContent = getHBFaultString(ch.fault);\n"
"                    } else {\n"
"                        faultRow.style.display = 'none';\n"
"                    }\n"
"                }\n"
"            }\n"
"            \n"
"            // Update analog inputs (differential - update only values + color)\n"
"            for (let i = 0; i < 20; i++) {\n"
"                const v = data.analogs?.[i] || 0;\n"
"                const chEl = document.getElementById('analog-ch-' + i);\n"
"                const valEl = document.getElementById('ain-val-' + i);\n"
"                if (valEl) valEl.textContent = v.toFixed(2) + 'V';\n"
"                if (chEl) {\n"
"                    chEl.classList.remove('v-zero','v-low','v-med','v-norm','v-high','v-max');\n"
"                    if (v <= 0.05) chEl.classList.add('v-zero');\n"
"                    else if (v <= 0.5) chEl.classList.add('v-low');\n"
"                    else if (v <= 2) chEl.classList.add('v-med');\n"
"                    else if (v <= 5) chEl.classList.add('v-norm');\n"
"                    else if (v <= 10) chEl.classList.add('v-high');\n"
"                    else chEl.classList.add('v-max');\n"
"                }\n"
"            }\n"
"            \n"
"            // Update digital inputs\n"
"            if (data.digitalInputs) {\n"
"                updateDigitalInputs(data.digitalInputs);\n"
"            }\n"
"            \n"
"            // System status (differential - update only values)\n"
"            const sysVoltage = document.getElementById('sys-voltage');\n"
"            if (sysVoltage) sysVoltage.textContent = (data.voltage || 0).toFixed(1) + 'V';\n"
"            const sysTemp = document.getElementById('sys-temp');\n"
"            if (sysTemp) sysTemp.textContent = (data.temperature || 0).toFixed(0) + 'C';\n"
"            const sysUptime = document.getElementById('sys-uptime');\n"
"            if (sysUptime) sysUptime.textContent = (data.uptime || 0) + 's';\n"
"            const sysTick = document.getElementById('sys-tick');\n"
"            if (sysTick) sysTick.textContent = data.tick || 0;\n"
"            \n"
"            // Update load grid (differential)\n"
"            updateLoadGridValues();\n"
"            \n"
"            // Update active faults list\n"
"            updateFaultList(data);\n"
"            \n"
"            // Update WiFi status\n"
"            if (data.wifi) {\n"
"                updateWifiStatus(data.wifi);\n"
"            }\n"
"            \n"
"            // Update Bluetooth status\n"
"            if (data.bluetooth) {\n"
"                updateBluetoothStatus(data.bluetooth);\n"
"            }\n"
"            \n"
"            // Update LIN status\n"
"            if (data.lin) {\n"
"                updateLinStatus(data.lin);\n"
"            }\n"
"        }\n"
"        \n"
"        // WiFi state names\n"
"        const wifiStateNames = ['OFF', 'INIT', 'SCANNING', 'CONNECTING', 'CONNECTED', 'AP_MODE', 'ERROR'];\n"
"        const wifiModeNames = ['Station', 'AP', 'STA+AP'];\n"
"        let wifiEnabled = false;\n"
"        let wifiApMode = false;\n"
"        \n"
"        function updateWifiStatus(wifi) {\n"
"            const indicator = document.getElementById('wifiIndicator');\n"
"            const stateEl = document.getElementById('wifiState');\n"
"            const modeEl = document.getElementById('wifiMode');\n"
"            const ipEl = document.getElementById('wifiIP');\n"
"            const rssiEl = document.getElementById('wifiRSSI');\n"
"            const clientsEl = document.getElementById('wifiClients');\n"
"            const toggleBtn = document.getElementById('wifiToggleBtn');\n"
"            \n"
"            const state = wifi.state || 0;\n"
"            wifiEnabled = state > 0 && state !== 6;\n"
"            wifiApMode = wifi.mode === 1 || wifi.mode === 2;\n"
"            \n"
"            if (stateEl) {\n"
"                stateEl.textContent = wifiStateNames[state] || 'UNKNOWN';\n"
"                stateEl.className = 'comm-val ' + (state === 4 || state === 5 ? 'online' : state === 6 ? 'error' : 'offline');\n"
"            }\n"
"            if (modeEl) modeEl.textContent = wifiModeNames[wifi.mode] || '-';\n"
"            if (ipEl) ipEl.textContent = wifi.ip || '0.0.0.0';\n"
"            if (rssiEl) rssiEl.textContent = state > 0 ? (wifi.rssi + ' dBm') : '-';\n"
"            if (clientsEl) clientsEl.textContent = wifi.clients || 0;\n"
"            \n"
"            if (indicator) {\n"
"                indicator.className = 'comm-indicator';\n"
"                if (state === 4 || state === 5) indicator.classList.add('on');\n"
"                else if (state >= 1 && state <= 3) indicator.classList.add('connecting');\n"
"                else if (state === 6) indicator.classList.add('error');\n"
"            }\n"
"            \n"
"            if (toggleBtn) toggleBtn.textContent = wifiEnabled ? 'Disable' : 'Enable';\n"
"        }\n"
"        \n"
"        // Bluetooth state names\n"
"        const btStateNames = ['OFF', 'INIT', 'ADVERTISING', 'CONNECTED', 'PAIRING', 'ERROR'];\n"
"        const btModeNames = ['Classic', 'BLE', 'Dual'];\n"
"        let btEnabled = false;\n"
"        let btBleMode = false;\n"
"        let btAdvertising = false;\n"
"        \n"
"        function updateBluetoothStatus(bt) {\n"
"            const indicator = document.getElementById('btIndicator');\n"
"            const stateEl = document.getElementById('btState');\n"
"            const modeEl = document.getElementById('btMode');\n"
"            const macEl = document.getElementById('btMAC');\n"
"            const connEl = document.getElementById('btConnections');\n"
"            const toggleBtn = document.getElementById('btToggleBtn');\n"
"            const advBtn = document.getElementById('btAdvBtn');\n"
"            \n"
"            const state = bt.state || 0;\n"
"            btEnabled = state > 0 && state !== 5;\n"
"            btAdvertising = state === 2;\n"
"            btBleMode = bt.mode === 1 || bt.mode === 2;\n"
"            \n"
"            if (stateEl) {\n"
"                stateEl.textContent = btStateNames[state] || 'UNKNOWN';\n"
"                stateEl.className = 'comm-val ' + (state === 3 ? 'online' : state === 5 ? 'error' : 'offline');\n"
"            }\n"
"            if (modeEl) modeEl.textContent = btModeNames[bt.mode] || '-';\n"
"            if (macEl) macEl.textContent = bt.mac || '00:00:00:00:00:00';\n"
"            if (connEl) connEl.textContent = bt.connections || 0;\n"
"            \n"
"            if (indicator) {\n"
"                indicator.className = 'comm-indicator';\n"
"                if (state === 3) indicator.classList.add('on');\n"
"                else if (state >= 1 && state <= 2) indicator.classList.add('connecting');\n"
"                else if (state === 5) indicator.classList.add('error');\n"
"            }\n"
"            \n"
"            if (toggleBtn) toggleBtn.textContent = btEnabled ? 'Disable' : 'Enable';\n"
"            if (advBtn) advBtn.textContent = btAdvertising ? 'Stop Adv' : 'Advertise';\n"
"        }\n"
"        \n"
"        function toggleWifi() {\n"
"            wifiEnabled = !wifiEnabled;\n"
"            ws.send(JSON.stringify({action: 'set_wifi', enabled: wifiEnabled ? 1 : 0}));\n"
"        }\n"
"        \n"
"        function toggleWifiMode() {\n"
"            wifiApMode = !wifiApMode;\n"
"            ws.send(JSON.stringify({action: 'set_wifi', enabled: 1, ap_mode: wifiApMode ? 1 : 0}));\n"
"        }\n"
"        \n"
"        function toggleBluetooth() {\n"
"            btEnabled = !btEnabled;\n"
"            ws.send(JSON.stringify({action: 'set_bluetooth', enabled: btEnabled ? 1 : 0}));\n"
"        }\n"
"        \n"
"        function toggleBleMode() {\n"
"            btBleMode = !btBleMode;\n"
"            ws.send(JSON.stringify({action: 'set_bluetooth', enabled: 1, ble_mode: btBleMode ? 1 : 0}));\n"
"        }\n"
"        \n"
"        function toggleBtAdvertise() {\n"
"            btAdvertising = !btAdvertising;\n"
"            ws.send(JSON.stringify({action: 'bt_advertise', advertise: btAdvertising ? 1 : 0}));\n"
"        }\n"
"        \n"
"        // ==================== LIN Bus Functions ====================\n"
"        const linStateNames = ['OFF', 'IDLE', 'ACTIVE', 'SLEEP', 'ERROR'];\n"
"        let linEnabled = [false, false];\n"
"        \n"
"        function updateLinStatus(linData) {\n"
"            if (!linData || !Array.isArray(linData)) return;\n"
"            let activeCount = 0;\n"
"            for (let i = 0; i < Math.min(linData.length, 2); i++) {\n"
"                const lin = linData[i];\n"
"                const state = lin.state || 0;\n"
"                linEnabled[i] = state > 0 && state !== 4;\n"
"                if (state > 0 && state < 4) activeCount++;\n"
"                \n"
"                const indicator = document.getElementById('linIndicator' + i);\n"
"                const stateEl = document.getElementById('linState' + i);\n"
"                const modeEl = document.getElementById('linMode' + i);\n"
"                const baudEl = document.getElementById('linBaud' + i);\n"
"                const rxEl = document.getElementById('linRx' + i);\n"
"                const txEl = document.getElementById('linTx' + i);\n"
"                const errEl = document.getElementById('linErr' + i);\n"
"                const toggleBtn = document.getElementById('linToggle' + i);\n"
"                \n"
"                if (stateEl) {\n"
"                    stateEl.textContent = linStateNames[state] || 'UNKNOWN';\n"
"                    stateEl.className = 'lin-val ' + (state === 2 ? 'active' : state === 3 ? 'sleep' : state === 4 ? 'error' : '');\n"
"                }\n"
"                if (modeEl) modeEl.textContent = lin.is_master ? 'Master' : 'Slave';\n"
"                if (baudEl) baudEl.textContent = lin.baudrate ? (lin.baudrate / 1000).toFixed(1) + 'k' : '-';\n"
"                if (rxEl) rxEl.textContent = lin.frames_rx || 0;\n"
"                if (txEl) txEl.textContent = lin.frames_tx || 0;\n"
"                if (errEl) { errEl.textContent = lin.errors || 0; errEl.style.color = (lin.errors > 0) ? '#f55' : '#fff'; }\n"
"                \n"
"                if (indicator) {\n"
"                    indicator.className = 'comm-indicator';\n"
"                    if (state === 2) indicator.classList.add('on');\n"
"                    else if (state === 1) indicator.classList.add('connecting');\n"
"                    else if (state === 4) indicator.classList.add('error');\n"
"                }\n"
"                \n"
"                if (toggleBtn) toggleBtn.textContent = linEnabled[i] ? 'Disable' : 'Enable';\n"
"            }\n"
"            document.getElementById('linActiveCount').textContent = activeCount + '/2 Active';\n"
"        }\n"
"        \n"
"        function toggleLin(bus) {\n"
"            linEnabled[bus] = !linEnabled[bus];\n"
"            sendCommand({action: 'set_lin', bus: bus, enabled: linEnabled[bus] ? 1 : 0});\n"
"        }\n"
"        \n"
"        function linWakeup(bus) {\n"
"            sendCommand({action: 'lin_wakeup', bus: bus});\n"
"            addLog('info', 'lin', 'LIN' + bus + ' wakeup sent');\n"
"        }\n"
"        \n"
"        function linSleep(bus) {\n"
"            sendCommand({action: 'lin_sleep', bus: bus});\n"
"            addLog('info', 'lin', 'LIN' + bus + ' sleep sent');\n"
"        }\n"
"        \n"
"        function sendLinFrame() {\n"
"            const bus = parseInt(document.getElementById('linInjectBus').value);\n"
"            const id = parseInt(document.getElementById('linInjectId').value) || 0;\n"
"            if (id < 0 || id > 63) {\n"
"                addLog('error', 'lin', 'Invalid LIN ID (must be 0-63)');\n"
"                return;\n"
"            }\n"
"            let data = [];\n"
"            for (let i = 0; i < 8; i++) {\n"
"                const val = parseInt(document.getElementById('linD' + i).value, 16);\n"
"                if (!isNaN(val)) data.push(val & 0xFF);\n"
"            }\n"
"            if (data.length === 0) data = [0];\n"
"            sendCommand({action: 'inject_lin', bus: bus, id: id, data: data});\n"
"            addLinHistory('tx', bus, id, data);\n"
"        }\n"
"        \n"
"        function addLinHistory(dir, bus, id, data) {\n"
"            const container = document.getElementById('linHistory');\n"
"            const entry = document.createElement('div');\n"
"            entry.className = 'lin-msg ' + dir;\n"
"            const dataStr = data.map(b => b.toString(16).padStart(2,'0').toUpperCase()).join(' ');\n"
"            const time = new Date().toLocaleTimeString();\n"
"            const pid = ((id & 0x3F) | ((((id >> 0) ^ (id >> 1) ^ (id >> 2) ^ (id >> 4)) & 1) << 6) | ((((id >> 1) ^ (id >> 3) ^ (id >> 4) ^ (id >> 5)) & 1) << 7)) ^ 0x40;\n"
"            entry.textContent = '[' + time + '] ' + dir.toUpperCase() + ' LIN' + bus + ' ID:0x' + id.toString(16).toUpperCase() + ' (PID:0x' + pid.toString(16).toUpperCase() + ') [' + dataStr + ']';\n"
"            container.appendChild(entry);\n"
"            container.scrollTop = container.scrollHeight;\n"
"            while (container.children.length > 30) container.removeChild(container.firstChild);\n"
"        }\n"
"        \n"
"        function getFaultString(fault) {\n"
"            /* PMU_PROFET_Fault_t: 0x01=OC, 0x02=OT, 0x04=SC, 0x08=OL, 0x10=UV */\n"
"            let s = [];\n"
"            if (fault & 0x01) s.push('OC');\n"
"            if (fault & 0x02) s.push('OT');\n"
"            if (fault & 0x04) s.push('SC');\n"
"            if (fault & 0x08) s.push('OL');\n"
"            if (fault & 0x10) s.push('UV');\n"
"            return s.join(',');\n"
"        }\n"
"        \n"
"        function getHBFaultString(fault) {\n"
"            let s = [];\n"
"            if (fault & 1) s.push('OC_FWD');\n"
"            if (fault & 2) s.push('OC_REV');\n"
"            if (fault & 4) s.push('OVERTEMP');\n"
"            if (fault & 8) s.push('STALL');\n"
"            if (fault & 16) s.push('POS_LOST');\n"
"            return s.join(',') || 'None';\n"
"        }\n"
"        \n"
"        // Channel modal variables\n"
"        let editingChannel = -1;\n"
"        \n"
"        function openChannelModal(ch) {\n"
"            console.log('[MODAL] openChannelModal ch=', ch);\n"
"            editingChannel = ch;\n"
"            const chData = telemetryData.profets?.[ch] || {};\n"
"            console.log('[MODAL] Channel data:', chData);\n"
"            document.getElementById('chModalTitle').textContent = 'Channel ' + (ch + 1);\n"
"            \n"
"            // Set current state in dropdown\n"
"            const state = chData.state || 0;\n"
"            let selectVal = 0;  // Default OFF\n"
"            if (state === 1) selectVal = 1;\n"
"            else if (state === 6) selectVal = 6;\n"
"            document.getElementById('chStateSelect').value = selectVal;\n"
"            \n"
"            // Set PWM duty\n"
"            const duty = (chData.pwm_duty || 0) / 10;\n"
"            document.getElementById('chPwmSlider').value = duty;\n"
"            document.getElementById('chPwmVal').textContent = duty.toFixed(0) + '%';\n"
"            document.getElementById('chPwmRow').style.display = (state === 6) ? 'flex' : 'none';\n"
"            \n"
"            // Set load resistance\n"
"            document.getElementById('chLoadInput').value = loadValues[ch] || 10;\n"
"            \n"
"            // Show current fault status\n"
"            const fault = chData.fault || 0;\n"
"            document.getElementById('chFaultStatus').textContent = fault ? 'Fault: ' + getFaultString(fault) : 'No fault';\n"
"            document.getElementById('chFaultStatus').style.color = fault ? '#f55' : '#5f5';\n"
"            \n"
"            document.getElementById('channelModal').classList.add('show');\n"
"        }\n"
"        \n"
"        function closeChannelModal() {\n"
"            console.log('[MODAL] closeChannelModal');\n"
"            document.getElementById('channelModal').classList.remove('show');\n"
"            editingChannel = -1;\n"
"        }\n"
"        \n"
"        // Handle state select dropdown change\n"
"        function onStateSelectChange() {\n"
"            const sel = document.getElementById('chStateSelect');\n"
"            const state = parseInt(sel.value);\n"
"            console.log('State selected: ' + state);\n"
"            // Show/hide PWM slider\n"
"            document.getElementById('chPwmRow').style.display = (state === 6) ? 'flex' : 'none';\n"
"        }\n"
"        \n"
"        function updateChPwmDisplay() {\n"
"            const v = parseFloat(document.getElementById('chPwmSlider').value);\n"
"            document.getElementById('chPwmVal').textContent = v.toFixed(0) + '%';\n"
"        }\n"
"        \n"
"        function applyChannelSettings() {\n"
"            console.log('=== applyChannelSettings START ===');\n"
"            console.log('editingChannel=' + editingChannel);\n"
"            if (editingChannel < 0) {\n"
"                console.log('ERROR: editingChannel < 0!');\n"
"                alert('Error: No channel selected');\n"
"                return;\n"
"            }\n"
"            const ch = editingChannel;\n"
"            \n"
"            // Get state from dropdown\n"
"            const state = parseInt(document.getElementById('chStateSelect').value);\n"
"            console.log('Selected state=' + state);\n"
"            \n"
"            // Get PWM duty\n"
"            const duty = parseFloat(document.getElementById('chPwmSlider').value);\n"
"            \n"
"            // Get load\n"
"            const load = parseFloat(document.getElementById('chLoadInput').value) || 10;\n"
"            loadValues[ch] = load;\n"
"            \n"
"            console.log('Applying settings: ch=' + ch + ', state=' + state + ', pwm=' + (duty * 10));\n"
"            \n"
"            // Log to WebUI\n"
"            const stateStr = state === 0 ? 'OFF' : (state === 1 ? 'ON' : 'PWM ' + duty + '%');\n"
"            addLog('info', 'cmd', 'Sending CH' + (ch+1) + ' ' + stateStr);\n"
"            \n"
"            // Send commands\n"
"            sendCommand({action: 'set_channel', channel: ch, state: state, pwm: duty * 10});\n"
"            sendCommand({action: 'set_load', channel: ch, resistance: load});\n"
"            \n"
"            updateLoadGridValues();\n"
"            closeChannelModal();\n"
"        }\n"
"        \n"
"        function injectFault(faultType) {\n"
"            if (editingChannel < 0) return;\n"
"            sendCommand({action: 'inject_fault', channel: editingChannel, fault: faultType});\n"
"        }\n"
"        \n"
"        function clearChFault() {\n"
"            if (editingChannel < 0) return;\n"
"            sendCommand({action: 'clear_fault', channel: editingChannel});\n"
"        }\n"
"        \n"
"        function editAnalog(ch) {\n"
"            console.log('[MODAL] editAnalog ch=', ch);\n"
"            editingAnalog = ch;\n"
"            const v = telemetryData.analogs?.[ch] || 0;\n"
"            console.log('[MODAL] Analog value:', v);\n"
"            document.getElementById('analogModalTitle').textContent = 'AIN' + (ch + 1);\n"
"            document.getElementById('analogSlider').value = v;\n"
"            document.getElementById('analogValue').textContent = v.toFixed(2) + 'V';\n"
"            document.getElementById('analogModal').classList.add('show');\n"
"        }\n"
"        \n"
"        function closeAnalogModal() {\n"
"            console.log('[MODAL] closeAnalogModal');\n"
"            document.getElementById('analogModal').classList.remove('show');\n"
"            editingAnalog = -1;\n"
"        }\n"
"        \n"
"        function updateAnalogValue() {\n"
"            const v = parseFloat(document.getElementById('analogSlider').value);\n"
"            document.getElementById('analogValue').textContent = v.toFixed(2) + 'V';\n"
"            // Live update - send immediately\n"
"            if (editingAnalog >= 0) {\n"
"                sendCommand({action: 'set_analog', channel: editingAnalog, voltage: v});\n"
"            }\n"
"        }\n"
"        \n"
"        function setAnalogPreset(v) {\n"
"            document.getElementById('analogSlider').value = v;\n"
"            document.getElementById('analogValue').textContent = v.toFixed(2) + 'V';\n"
"            if (editingAnalog >= 0) {\n"
"                sendCommand({action: 'set_analog', channel: editingAnalog, voltage: v});\n"
"            }\n"
"        }\n"
"        \n"
"        function applyAnalogValue() {\n"
"            const v = parseFloat(document.getElementById('analogSlider').value);\n"
"            if (editingAnalog >= 0) {\n"
"                sendCommand({action: 'set_analog', channel: editingAnalog, voltage: v});\n"
"            }\n"
"            closeAnalogModal();\n"
"        }\n"
"        \n"
"        // Battery voltage slider\n"
"        document.getElementById('battVoltage').addEventListener('input', function() {\n"
"            const v = parseFloat(this.value);\n"
"            document.getElementById('battVoltageVal').textContent = v.toFixed(1) + 'V';\n"
"        });\n"
"        document.getElementById('battVoltage').addEventListener('change', function() {\n"
"            const v = parseFloat(this.value);\n"
"            sendCommand({action: 'set_voltage', voltage: v * 1000});\n"
"        });\n"
"        \n"
"        // Board temperature slider\n"
"        document.getElementById('boardTemp').addEventListener('input', function() {\n"
"            const t = parseInt(this.value);\n"
"            document.getElementById('boardTempVal').textContent = t + 'C';\n"
"        });\n"
"        document.getElementById('boardTemp').addEventListener('change', function() {\n"
"            const t = parseInt(this.value);\n"
"            sendCommand({action: 'set_temperature', temperature: t});\n"
"        });\n"
"        \n"
"        // Load simulation - differential update (values only)\n"
"        function updateLoadGridValues() {\n"
"            for (let i = 0; i < 30; i++) {\n"
"                const r = loadValues[i];\n"
"                const cls = r < 0.1 ? 'short' : (r > 1000 ? 'open' : '');\n"
"                const rStr = r >= 1000 ? (r/1000).toFixed(1)+'k' : r.toFixed(1);\n"
"                const chDiv = document.getElementById('load-ch-' + i);\n"
"                if (chDiv) {\n"
"                    chDiv.className = 'load-ch ' + cls;\n"
"                }\n"
"                const valEl = document.getElementById('load-val-' + i);\n"
"                if (valEl) valEl.textContent = rStr + 'R';\n"
"            }\n"
"        }\n"
"        \n"
"        function setAllLoads(r) {\n"
"            for (let i = 0; i < 30; i++) {\n"
"                loadValues[i] = r;\n"
"                sendCommand({action: 'set_load', channel: i, resistance: r});\n"
"            }\n"
"            updateLoadGridValues();\n"
"        }\n"
"        \n"
"        function openLoadModal(ch) {\n"
"            console.log('[MODAL] openLoadModal ch=', ch);\n"
"            selectedLoadCh = ch;\n"
"            document.getElementById('loadModalCh').textContent = ch + 1;\n"
"            document.getElementById('loadModalValue').value = loadValues[ch];\n"
"            document.getElementById('loadModal').classList.add('show');\n"
"        }\n"
"        \n"
"        function closeLoadModal() {\n"
"            console.log('[MODAL] closeLoadModal');\n"
"            document.getElementById('loadModal').classList.remove('show');\n"
"        }\n"
"        \n"
"        function setLoadValue(r) {\n"
"            document.getElementById('loadModalValue').value = r;\n"
"        }\n"
"        \n"
"        function applyLoadModal() {\n"
"            const r = parseFloat(document.getElementById('loadModalValue').value) || 10;\n"
"            loadValues[selectedLoadCh] = r;\n"
"            sendCommand({action: 'set_load', channel: selectedLoadCh, resistance: r});\n"
"            updateLoadGridValues();\n"
"            closeLoadModal();\n"
"        }\n"
"        \n"
"        // CAN injection\n"
"        function sendCanMessage() {\n"
"            const bus = parseInt(document.getElementById('canBus').value);\n"
"            const id = parseInt(document.getElementById('canId').value, 16) || 0x100;\n"
"            let data = [];\n"
"            for (let i = 0; i < 8; i++) {\n"
"                data.push(parseInt(document.getElementById(`canD${i}`).value, 16) || 0);\n"
"            }\n"
"            sendCommand({action: 'inject_can', bus: bus, id: id, data: data});\n"
"            addCanHistory('tx', bus, id, data);\n"
"        }\n"
"        \n"
"        function addCanHistory(dir, bus, id, data) {\n"
"            const container = document.getElementById('canHistory');\n"
"            const entry = document.createElement('div');\n"
"            entry.className = `can-msg ${dir}`;\n"
"            const dataStr = data.map(b => b.toString(16).padStart(2,'0').toUpperCase()).join(' ');\n"
"            const time = new Date().toLocaleTimeString();\n"
"            entry.textContent = `[${time}] ${dir.toUpperCase()} CAN${bus} ID:${id.toString(16).toUpperCase()} [${dataStr}]`;\n"
"            container.appendChild(entry);\n"
"            container.scrollTop = container.scrollHeight;\n"
"            while (container.children.length > 50) container.removeChild(container.firstChild);\n"
"        }\n"
"        \n"
"        // Fault injection\n"
"        // Initialize static PROFET grid (called once at page load)\n"
"        function initProfetGrid() {\n"
"            console.log('[INIT] initProfetGrid()');\n"
"            const grid = document.getElementById('profetGrid');\n"
"            let html = '';\n"
"            for (let i = 0; i < 30; i++) {\n"
"                html += '<div class=\"profet-ch\" id=\"profet-ch-' + i + '\" data-ch=\"' + i + '\">';\n"
"                html += '<div class=\"ch-num\">CH' + (i+1) + '</div>';\n"
"                html += '<div class=\"ch-val\">0.0A</div>';\n"
"                html += '<div class=\"ch-pwm\" style=\"display:none\">0%</div>';\n"
"                html += '<div class=\"tooltip\"><b>Channel ' + (i+1) + '</b></div>';\n"
"                html += '</div>';\n"
"            }\n"
"            grid.innerHTML = html;\n"
"        }\n"
"        \n"
"        // Initialize static Analog grid (called once at page load)\n"
"        function initAnalogGrid() {\n"
"            console.log('[INIT] initAnalogGrid()');\n"
"            const grid = document.getElementById('analogGrid');\n"
"            let html = '';\n"
"            for (let i = 0; i < 20; i++) {\n"
"                html += '<div class=\"analog-ch\" id=\"analog-ch-' + i + '\" data-ch=\"' + i + '\">';\n"
"                html += '<div class=\"ain-label\">AIN' + (i+1) + '</div>';\n"
"                html += '<div class=\"ain-val\" id=\"ain-val-' + i + '\">0.00V</div>';\n"
"                html += '</div>';\n"
"            }\n"
"            grid.innerHTML = html;\n"
"        }\n"
"        \n"
"        // Initialize static Digital Input grid (called once at page load)\n"
"        function initDigitalGrid() {\n"
"            console.log('[INIT] initDigitalGrid()');\n"
"            const grid = document.getElementById('digitalGrid');\n"
"            let html = '';\n"
"            for (let i = 0; i < 16; i++) {\n"
"                html += '<div class=\"di-ch\" id=\"di-ch-' + i + '\" data-ch=\"' + i + '\" onclick=\"toggleDI(' + i + ')\">';\n"
"                html += '<span class=\"di-label\">DI' + (i+1) + '</span>';\n"
"                html += '<span class=\"di-val\" id=\"di-val-' + i + '\">LOW</span>';\n"
"                html += '</div>';\n"
"            }\n"
"            grid.innerHTML = html;\n"
"        }\n"
"        \n"
"        // Toggle digital input\n"
"        function toggleDI(channel) {\n"
"            sendCommand({ action: 'toggle_digital_input', channel: channel });\n"
"        }\n"
"        \n"
"        // Update digital input display\n"
"        function updateDigitalInputs(states) {\n"
"            if (!states || states.length < 16) return;\n"
"            for (let i = 0; i < 16; i++) {\n"
"                const ch = document.getElementById('di-ch-' + i);\n"
"                const val = document.getElementById('di-val-' + i);\n"
"                if (ch && val) {\n"
"                    if (states[i]) {\n"
"                        ch.classList.add('di-high');\n"
"                        val.textContent = 'HIGH';\n"
"                    } else {\n"
"                        ch.classList.remove('di-high');\n"
"                        val.textContent = 'LOW';\n"
"                    }\n"
"                }\n"
"            }\n"
"        }\n"
"        \n"
"        // Initialize static H-Bridge grid (called once at page load)\n"
"        function initHBridgeGrid() {\n"
"            console.log('[INIT] initHBridgeGrid()');\n"
"            const grid = document.getElementById('hbridgeGrid');\n"
"            let html = '';\n"
"            for (let i = 0; i < 4; i++) {\n"
"                html += '<div class=\"hbridge-ch\" id=\"hbridge-ch-' + i + '\">';\n"
"                html += '<div class=\"hb-title\">HB' + (i+1) + '</div>';\n"
"                html += '<div class=\"hb-row\"><span class=\"hb-label\">Mode:</span><span class=\"hb-val\" id=\"hb-mode-' + i + '\">COAST</span></div>';\n"
"                html += '<div class=\"hb-row\"><span class=\"hb-label\">State:</span><span class=\"hb-val\" id=\"hb-state-' + i + '\">IDLE</span></div>';\n"
"                html += '<div class=\"hb-row\"><span class=\"hb-label\">PWM:</span><span class=\"hb-val\" id=\"hb-pwm-' + i + '\">0%</span></div>';\n"
"                html += '<div class=\"hb-row\"><span class=\"hb-label\">Current:</span><span class=\"hb-val\" id=\"hb-curr-' + i + '\">0.00A</span></div>';\n"
"                html += '<div class=\"hb-row\"><span class=\"hb-label\">Position:</span><span class=\"hb-val\" id=\"hb-pos-' + i + '\">0.0%</span></div>';\n"
"                html += '<div class=\"pos-bar\"><div class=\"pos-fill\" id=\"hb-bar-' + i + '\" style=\"width:0%\"></div></div>';\n"
"                html += '<div class=\"hb-row\"><span class=\"hb-label\">Speed:</span><span class=\"hb-val\" id=\"hb-omega-' + i + '\">0 rad/s</span></div>';\n"
"                html += '<div class=\"hb-row\"><span class=\"hb-label\">Back-EMF:</span><span class=\"hb-val\" id=\"hb-bemf-' + i + '\">0.0V</span></div>';\n"
"                html += '<div class=\"hb-row\"><span class=\"hb-label\">Torque:</span><span class=\"hb-val\" id=\"hb-torque-' + i + '\">0.00 Nm</span></div>';\n"
"                html += '<div class=\"hb-row\"><span class=\"hb-label\">Temp:</span><span class=\"hb-val\" id=\"hb-temp-' + i + '\">25C</span></div>';\n"
"                html += '<div class=\"hb-row\" id=\"hb-fault-row-' + i + '\" style=\"display:none\"><span class=\"hb-label\">Fault:</span><span class=\"hb-val\" id=\"hb-fault-' + i + '\" style=\"color:#f55\"></span></div>';\n"
"                html += '</div>';\n"
"            }\n"
"            grid.innerHTML = html;\n"
"        }\n"
"        \n"
"        // Initialize static System Status (called once at page load)\n"
"        function initSysStatus() {\n"
"            console.log('[INIT] initSysStatus()');\n"
"            document.getElementById('sysStatus').innerHTML = \n"
"                '<div class=\"sys-item\"><div class=\"si-label\">Voltage</div><div class=\"si-val\" id=\"sys-voltage\">0.0V</div></div>' +\n"
"                '<div class=\"sys-item\"><div class=\"si-label\">Temp</div><div class=\"si-val\" id=\"sys-temp\">0C</div></div>' +\n"
"                '<div class=\"sys-item\"><div class=\"si-label\">Uptime</div><div class=\"si-val\" id=\"sys-uptime\">0s</div></div>' +\n"
"                '<div class=\"sys-item\"><div class=\"si-label\">Tick</div><div class=\"si-val\" id=\"sys-tick\">0</div></div>';\n"
"        }\n"
"        \n"
"        // Initialize static Load grid (called once at page load)\n"
"        function initLoadGrid() {\n"
"            console.log('[INIT] initLoadGrid()');\n"
"            const grid = document.getElementById('loadGrid');\n"
"            let html = '';\n"
"            for (let i = 0; i < 30; i++) {\n"
"                html += '<div class=\"load-ch\" id=\"load-ch-' + i + '\" data-ch=\"' + i + '\">';\n"
"                html += '<div class=\"ld-num\">CH' + (i+1) + '</div>';\n"
"                html += '<div class=\"ld-val\" id=\"load-val-' + i + '\">10.0R</div>';\n"
"                html += '</div>';\n"
"            }\n"
"            grid.innerHTML = html;\n"
"        }\n"
"        \n"
"        function initFaultChannelSelect() {\n"
"            const sel = document.getElementById('faultChannel');\n"
"            let html = '<optgroup label=\"PROFET\">';\n"
"            for (let i = 1; i <= 30; i++) html += `<option value=\"p${i}\">PROFET CH${i}</option>`;\n"
"            html += '</optgroup><optgroup label=\"H-Bridge\">';\n"
"            for (let i = 1; i <= 4; i++) html += `<option value=\"h${i}\">H-Bridge ${i}</option>`;\n"
"            html += '</optgroup>';\n"
"            sel.innerHTML = html;\n"
"        }\n"
"        \n"
"        function injectFault() {\n"
"            const ch = document.getElementById('faultChannel').value;\n"
"            const fault = parseInt(document.getElementById('faultType').value);\n"
"            if (ch.startsWith('p')) {\n"
"                const chNum = parseInt(ch.substring(1)) - 1;\n"
"                sendCommand({action: 'inject_fault', type: 'profet', channel: chNum, fault: fault});\n"
"            } else if (ch.startsWith('h')) {\n"
"                const chNum = parseInt(ch.substring(1)) - 1;\n"
"                sendCommand({action: 'inject_fault', type: 'hbridge', channel: chNum, fault: fault});\n"
"            }\n"
"        }\n"
"        \n"
"        function clearFault(type, ch) {\n"
"            sendCommand({action: 'clear_fault', type: type, channel: ch});\n"
"        }\n"
"        \n"
"        function updateFaultList(data) {\n"
"            let html = '';\n"
"            // PROFET faults (use data attributes for event delegation)\n"
"            for (let i = 0; i < 30; i++) {\n"
"                const f = data.profets?.[i]?.fault || 0;\n"
"                if (f > 0) {\n"
"                    html += `<div class=\"fault-tag\">CH${i+1}: ${getFaultString(f)} <button class=\"fault-clear\" data-type=\"profet\" data-ch=\"${i}\">&times;</button></div>`;\n"
"                }\n"
"            }\n"
"            // H-Bridge faults (use data attributes for event delegation)\n"
"            for (let i = 0; i < 4; i++) {\n"
"                const f = data.hbridges?.[i]?.fault || 0;\n"
"                if (f > 0) {\n"
"                    html += `<div class=\"fault-tag\">HB${i+1}: ${getHBFaultString(f)} <button class=\"fault-clear\" data-type=\"hbridge\" data-ch=\"${i}\">&times;</button></div>`;\n"
"                }\n"
"            }\n"
"            document.getElementById('faultList').innerHTML = html || '<span style=\"color:#888\">No active faults</span>';\n"
"        }\n"
"        \n"
"        // Logging\n"
"        function addLog(level, source, message) {\n"
"            const container = document.getElementById('logContainer');\n"
"            const entry = document.createElement('div');\n"
"            let cls = level;\n"
"            if (source === 'cmd' || source === 'protocol') cls = 'cmd';\n"
"            if (source === 'config' || source === 'json') cls = 'config';\n"
"            entry.className = `log-entry ${cls}`;\n"
"            entry.dataset.source = source;\n"
"            entry.dataset.level = level;\n"
"            const time = new Date().toLocaleTimeString();\n"
"            entry.textContent = `[${time}] [${source}] ${message}`;\n"
"            container.appendChild(entry);\n"
"            container.scrollTop = container.scrollHeight;\n"
"            while (container.children.length > 200) container.removeChild(container.firstChild);\n"
"            applyLogFilter();\n"
"        }\n"
"        \n"
"        function switchLogTab(filter) {\n"
"            currentLogFilter = filter;\n"
"            document.querySelectorAll('.log-tab').forEach(t => t.classList.remove('active'));\n"
"            document.querySelector(`.log-tab[data-log=\"${filter}\"]`).classList.add('active');\n"
"            applyLogFilter();\n"
"        }\n"
"        \n"
"        function applyLogFilter() {\n"
"            document.querySelectorAll('.log-entry').forEach(entry => {\n"
"                const src = entry.dataset.source;\n"
"                const lvl = entry.dataset.level;\n"
"                let show = currentLogFilter === 'all';\n"
"                if (currentLogFilter === 'cmd' && (src === 'cmd' || src === 'protocol')) show = true;\n"
"                if (currentLogFilter === 'config' && (src === 'config' || src === 'json')) show = true;\n"
"                if (currentLogFilter === 'error' && lvl === 'error') show = true;\n"
"                entry.style.display = show ? '' : 'none';\n"
"            });\n"
"        }\n"
"        \n"
"        function sendCommand(cmd) {\n"
"            console.log('sendCommand:', cmd, 'ws.readyState:', ws ? ws.readyState : 'null');\n"
"            if (ws && ws.readyState === WebSocket.OPEN) {\n"
"                ws.send(JSON.stringify(cmd));\n"
"                console.log('Command sent successfully');\n"
"            } else {\n"
"                console.log('WebSocket not ready!');\n"
"            }\n"
"        }\n"
"        \n"
"        // Config Stats\n"
"        function refreshConfigStats() {\n"
"            fetch('/config-stats.json')\n"
"                .then(r => r.json())\n"
"                .then(data => {\n"
"                    const badge = document.getElementById('configStatusBadge');\n"
"                    const stats = document.getElementById('configStats');\n"
"                    const dl = document.getElementById('configDownloadLink');\n"
"                    if (data.loaded) {\n"
"                        badge.textContent = 'Loaded';\n"
"                        badge.className = 'badge on';\n"
"                        stats.innerHTML = `<div style=\"display:grid;grid-template-columns:repeat(2,1fr);gap:4px 12px\">`\n"
"                            + `<span>Total Channels:</span><strong>${data.channels}</strong>`\n"
"                            + `<span>Power Outputs:</span><strong>${data.powerOutputs}</strong>`\n"
"                            + `<span>Digital Inputs:</span><strong>${data.digitalInputs}</strong>`\n"
"                            + `<span>Analog Inputs:</span><strong>${data.analogInputs}</strong>`\n"
"                            + `<span>Logic Functions:</span><strong>${data.logic}</strong>`\n"
"                            + `<span>Switches:</span><strong>${data.switches}</strong>`\n"
"                            + `<span>Timers:</span><strong>${data.timers}</strong>`\n"
"                            + `<span>CAN Messages:</span><strong>${data.canMessages}</strong>`\n"
"                            + `<span>CAN RX:</span><strong>${data.canRx}</strong>`\n"
"                            + `<span>CAN TX:</span><strong>${data.canTx}</strong>`\n"
"                            + `<span>Tables 2D/3D:</span><strong>${data.tables2d}/${data.tables3d}</strong>`\n"
"                            + `<span>Lua Scripts:</span><strong>${data.luaScripts}</strong>`\n"
"                            + `</div>`;\n"
"                        dl.style.display = '';\n"
"                    } else {\n"
"                        badge.textContent = 'Not loaded';\n"
"                        badge.className = 'badge off';\n"
"                        stats.innerHTML = '<div style=\"color:#888\">No configuration loaded</div>';\n"
"                        dl.style.display = 'none';\n"
"                    }\n"
"                })\n"
"                .catch(e => console.error('Config stats error:', e));\n"
"        }\n"
"        \n"
"        function clearConfig() {\n"
"            if (confirm('Clear saved configuration? The emulator will reset to defaults.')) {\n"
"                sendCommand({action: 'clear_config'});\n"
"                setTimeout(refreshConfigStats, 500);\n"
"            }\n"
"        }\n"
"        \n"
"        function saveState() {\n"
"            sendCommand({action: 'save_state'});\n"
"            addLog('info', 'system', 'Saving emulator state...');\n"
"        }\n"
"        \n"
"        function loadState() {\n"
"            sendCommand({action: 'load_state'});\n"
"            addLog('info', 'system', 'Loading emulator state...');\n"
"        }\n"
"        \n"
"        function restartDevice() {\n"
"            if (confirm('Restart the PMU-30 device? All temporary settings will be reset.')) {\n"
"                sendCommand({action: 'restart_device'});\n"
"                addLog('warning', 'system', 'Device restart requested...');\n"
"            }\n"
"        }\n"
"        \n"
"        // Keyboard shortcuts\n"
"        document.addEventListener('keydown', function(e) {\n"
"            // Skip if typing in input/textarea\n"
"            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;\n"
"            \n"
"            // Ctrl+S = Save State\n"
"            if (e.ctrlKey && e.key === 's') {\n"
"                e.preventDefault();\n"
"                saveState();\n"
"            }\n"
"            // Ctrl+L = Load State\n"
"            if (e.ctrlKey && e.key === 'l') {\n"
"                e.preventDefault();\n"
"                loadState();\n"
"            }\n"
"            // Escape = Close modals\n"
"            if (e.key === 'Escape') {\n"
"                closeChannelModal();\n"
"                closeAnalogModal();\n"
"                closeLoadModal();\n"
"            }\n"
"            // 1-9, 0 = Quick channel toggle (CH1-CH10)\n"
"            if (!e.ctrlKey && !e.altKey && e.key >= '1' && e.key <= '9') {\n"
"                const ch = parseInt(e.key) - 1;\n"
"                sendCommand({action: 'toggle', channel: ch + 1});\n"
"            }\n"
"            if (!e.ctrlKey && !e.altKey && e.key === '0') {\n"
"                sendCommand({action: 'toggle', channel: 10});\n"
"            }\n"
"            // A = All outputs OFF\n"
"            if (!e.ctrlKey && e.key === 'a') {\n"
"                for (let i = 0; i < 30; i++) {\n"
"                    sendCommand({action: 'set_channel', channel: i, state: 0, pwm: 0});\n"
"                }\n"
"                addLog('info', 'system', 'All outputs OFF');\n"
"            }\n"
"        });\n"
"        \n"
"        // ==================== Link ECU CAN Stream ====================\n"
"        let linkStreamTimer = null;\n"
"        let linkFrameIdx = 0;\n"
"        \n"
"        function getLinkParams() {\n"
"            return {\n"
"                rpm: parseInt(document.getElementById('linkRpm').value) || 0,\n"
"                tps: parseFloat(document.getElementById('linkTps').value) || 0,\n"
"                map: parseInt(document.getElementById('linkMap').value) || 0,\n"
"                clt: parseInt(document.getElementById('linkClt').value) || 0,\n"
"                iat: parseInt(document.getElementById('linkIat').value) || 0,\n"
"                batt: parseFloat(document.getElementById('linkBatt').value) || 0,\n"
"                lambda1: parseFloat(document.getElementById('linkLambda1').value) || 1,\n"
"                lambda2: parseFloat(document.getElementById('linkLambda2').value) || 1,\n"
"                oilP: parseFloat(document.getElementById('linkOilP').value) || 0,\n"
"                oilT: parseInt(document.getElementById('linkOilT').value) || 0,\n"
"                fuelP: parseFloat(document.getElementById('linkFuelP').value) || 0,\n"
"                speed: parseInt(document.getElementById('linkSpeed').value) || 0,\n"
"                gear: parseInt(document.getElementById('linkGear').value) || 0,\n"
"                ign: parseFloat(document.getElementById('linkIgn').value) || 0,\n"
"                injDC: parseFloat(document.getElementById('linkInjDC').value) || 0,\n"
"                baro: parseInt(document.getElementById('linkBaro').value) || 101,\n"
"                bus: parseInt(document.getElementById('linkCanBus').value) || 1,\n"
"                baseId: parseInt(document.getElementById('linkBaseId').value, 16) || 0x3E8\n"
"            };\n"
"        }\n"
"        \n"
"        function buildLinkFrame(frameIdx, p) {\n"
"            let data = [frameIdx, 0, 0, 0, 0, 0, 0, 0];\n"
"            switch(frameIdx) {\n"
"                case 0: // RPM, MAP, MGP\n"
"                    data[2] = p.rpm & 0xFF; data[3] = (p.rpm >> 8) & 0xFF;\n"
"                    let mapVal = Math.round(p.map * 10);\n"
"                    data[4] = mapVal & 0xFF; data[5] = (mapVal >> 8) & 0xFF;\n"
"                    let mgpVal = Math.round((p.map - 100) * 10) + 1000;\n"
"                    data[6] = mgpVal & 0xFF; data[7] = (mgpVal >> 8) & 0xFF;\n"
"                    break;\n"
"                case 1: // Baro, TPS, InjDC\n"
"                    let baroVal = Math.round(p.baro * 10);\n"
"                    data[2] = baroVal & 0xFF; data[3] = (baroVal >> 8) & 0xFF;\n"
"                    let tpsVal = Math.round(p.tps * 10);\n"
"                    data[4] = tpsVal & 0xFF; data[5] = (tpsVal >> 8) & 0xFF;\n"
"                    let injDCVal = Math.round(p.injDC * 10);\n"
"                    data[6] = injDCVal & 0xFF; data[7] = (injDCVal >> 8) & 0xFF;\n"
"                    break;\n"
"                case 2: // InjPW, CLT\n"
"                    let injPW = Math.round(p.injDC * 0.2 * 10); // estimate\n"
"                    data[4] = injPW & 0xFF; data[5] = (injPW >> 8) & 0xFF;\n"
"                    let cltVal = Math.round((p.clt + 50) * 10);\n"
"                    data[6] = cltVal & 0xFF; data[7] = (cltVal >> 8) & 0xFF;\n"
"                    break;\n"
"                case 3: // IAT, Battery, MAF\n"
"                    let iatVal = Math.round((p.iat + 50) * 10);\n"
"                    data[2] = iatVal & 0xFF; data[3] = (iatVal >> 8) & 0xFF;\n"
"                    let battVal = Math.round(p.batt * 100);\n"
"                    data[4] = battVal & 0xFF; data[5] = (battVal >> 8) & 0xFF;\n"
"                    let mafVal = Math.round(p.rpm * 0.1); // estimate\n"
"                    data[6] = mafVal & 0xFF; data[7] = (mafVal >> 8) & 0xFF;\n"
"                    break;\n"
"                case 4: // Gear, IgnAngle\n"
"                    data[2] = p.gear & 0xFF; data[3] = 0;\n"
"                    let ignVal = Math.round((p.ign + 100) * 10);\n"
"                    data[6] = ignVal & 0xFF; data[7] = (ignVal >> 8) & 0xFF;\n"
"                    break;\n"
"                case 6: // Lambda1, Lambda2\n"
"                    let l1 = Math.round(p.lambda1 * 1000);\n"
"                    data[4] = l1 & 0xFF; data[5] = (l1 >> 8) & 0xFF;\n"
"                    let l2 = Math.round(p.lambda2 * 1000);\n"
"                    data[6] = l2 & 0xFF; data[7] = (l2 >> 8) & 0xFF;\n"
"                    break;\n"
"                case 7: // Trig errors, fault count, FuelP\n"
"                    data[2] = 0; data[3] = 0; // trig errors\n"
"                    data[4] = 0; data[5] = 0; // fault count\n"
"                    let fuelPVal = Math.round(p.fuelP * 10);\n"
"                    data[6] = fuelPVal & 0xFF; data[7] = (fuelPVal >> 8) & 0xFF;\n"
"                    break;\n"
"                case 8: // OilT, OilP, WheelSpeedLF\n"
"                    let oilTVal = Math.round((p.oilT + 50) * 10);\n"
"                    data[2] = oilTVal & 0xFF; data[3] = (oilTVal >> 8) & 0xFF;\n"
"                    let oilPVal = Math.round(p.oilP * 100);\n"
"                    data[4] = oilPVal & 0xFF; data[5] = (oilPVal >> 8) & 0xFF;\n"
"                    let wsLF = Math.round(p.speed * 10);\n"
"                    data[6] = wsLF & 0xFF; data[7] = (wsLF >> 8) & 0xFF;\n"
"                    break;\n"
"                case 9: // WheelSpeedLR, RF, RR\n"
"                    let ws = Math.round(p.speed * 10);\n"
"                    data[2] = ws & 0xFF; data[3] = (ws >> 8) & 0xFF;\n"
"                    data[4] = ws & 0xFF; data[5] = (ws >> 8) & 0xFF;\n"
"                    data[6] = ws & 0xFF; data[7] = (ws >> 8) & 0xFF;\n"
"                    break;\n"
"                default:\n"
"                    break;\n"
"            }\n"
"            return data;\n"
"        }\n"
"        \n"
"        function sendLinkFrame() {\n"
"            const p = getLinkParams();\n"
"            const frames = [0,1,2,3,4,6,7,8,9]; // Active frames\n"
"            const fIdx = frames[linkFrameIdx % frames.length];\n"
"            const data = buildLinkFrame(fIdx, p);\n"
"            sendCommand({action: 'inject_can', bus: p.bus, id: p.baseId, data: data});\n"
"            linkFrameIdx++;\n"
"        }\n"
"        \n"
"        function sendLinkFrameOnce() {\n"
"            const p = getLinkParams();\n"
"            const frames = [0,1,2,3,4,6,7,8,9];\n"
"            for (let fIdx of frames) {\n"
"                const data = buildLinkFrame(fIdx, p);\n"
"                sendCommand({action: 'inject_can', bus: p.bus, id: p.baseId, data: data});\n"
"                addCanHistory('tx', p.bus, p.baseId, data);\n"
"            }\n"
"            addLog('info', 'link', 'Sent all Link ECU frames once');\n"
"        }\n"
"        \n"
"        function toggleLinkStream() {\n"
"            if (linkStreamTimer) {\n"
"                clearInterval(linkStreamTimer);\n"
"                linkStreamTimer = null;\n"
"                document.getElementById('linkStartBtn').textContent = 'Start Stream';\n"
"                document.getElementById('linkStartBtn').classList.remove('danger');\n"
"                document.getElementById('linkStartBtn').classList.add('primary');\n"
"                document.getElementById('linkStreamStatus').textContent = 'Stopped';\n"
"                document.getElementById('linkStreamStatus').style.color = '#888';\n"
"                addLog('info', 'link', 'Link ECU stream stopped');\n"
"            } else {\n"
"                const interval = parseInt(document.getElementById('linkInterval').value) || 50;\n"
"                linkFrameIdx = 0;\n"
"                linkStreamTimer = setInterval(sendLinkFrame, interval);\n"
"                document.getElementById('linkStartBtn').textContent = 'Stop Stream';\n"
"                document.getElementById('linkStartBtn').classList.remove('primary');\n"
"                document.getElementById('linkStartBtn').classList.add('danger');\n"
"                document.getElementById('linkStreamStatus').textContent = 'Running @ ' + interval + 'ms';\n"
"                document.getElementById('linkStreamStatus').style.color = '#0f0';\n"
"                addLog('info', 'link', 'Link ECU stream started @ ' + interval + 'ms');\n"
"            }\n"
"        }\n"
"        \n"
"        // Initialize all static grids (called once at page load)\n"
"        console.log('[INIT] Starting page initialization...');\n"
"        initProfetGrid();\n"
"        initAnalogGrid();\n"
"        initDigitalGrid();\n"
"        initHBridgeGrid();\n"
"        initSysStatus();\n"
"        initLoadGrid();\n"
"        initFaultChannelSelect();\n"
"        refreshConfigStats();\n"
"        \n"
"        // Event delegation for PROFET grid (prevents issues with innerHTML updates)\n"
"        document.getElementById('profetGrid').addEventListener('click', function(e) {\n"
"            console.log('PROFET Grid click:', e.target.tagName, e.target.className);\n"
"            const chDiv = e.target.closest('.profet-ch');\n"
"            if (chDiv && chDiv.hasAttribute('data-ch')) {\n"
"                const ch = parseInt(chDiv.getAttribute('data-ch'));\n"
"                console.log('Opening PROFET modal for channel:', ch);\n"
"                openChannelModal(ch);\n"
"            }\n"
"        });\n"
"        \n"
"        // Event delegation for Analog grid (prevents issues with innerHTML updates)\n"
"        document.getElementById('analogGrid').addEventListener('click', function(e) {\n"
"            console.log('Analog Grid click:', e.target.tagName, e.target.className);\n"
"            const chDiv = e.target.closest('.analog-ch');\n"
"            if (chDiv && chDiv.hasAttribute('data-ch')) {\n"
"                const ch = parseInt(chDiv.getAttribute('data-ch'));\n"
"                console.log('Opening Analog modal for channel:', ch);\n"
"                editAnalog(ch);\n"
"            }\n"
"        });\n"
"        \n"
"        // Event delegation for Load grid (prevents issues with innerHTML updates)\n"
"        document.getElementById('loadGrid').addEventListener('click', function(e) {\n"
"            console.log('Load Grid click:', e.target.tagName, e.target.className);\n"
"            const chDiv = e.target.closest('.load-ch');\n"
"            if (chDiv && chDiv.hasAttribute('data-ch')) {\n"
"                const ch = parseInt(chDiv.getAttribute('data-ch'));\n"
"                console.log('Opening Load modal for channel:', ch);\n"
"                openLoadModal(ch);\n"
"            }\n"
"        });\n"
"        \n"
"        // Event delegation for Fault list clear buttons\n"
"        document.getElementById('faultList').addEventListener('click', function(e) {\n"
"            if (e.target.classList.contains('fault-clear')) {\n"
"                const type = e.target.getAttribute('data-type');\n"
"                const ch = parseInt(e.target.getAttribute('data-ch'));\n"
"                console.log('Clearing fault:', type, ch);\n"
"                clearFault(type, ch);\n"
"            }\n"
"        });\n"
"        \n"
"        connect();\n"
"    </script>\n"
"    \n"
"    <!-- Channel Control Dialog -->\n"
"    <div class=\"modal\" id=\"channelModal\">\n"
"        <div class=\"modal-content\" style=\"width: 400px;\">\n"
"            <div class=\"modal-header\">\n"
"                <h3 id=\"chModalTitle\">Channel 1</h3>\n"
"                <button class=\"modal-close\" onclick=\"closeChannelModal()\">&times;</button>\n"
"            </div>\n"
"            <div style=\"padding: 15px 0;\">\n"
"                <!-- State Selection -->\n"
"                <div style=\"margin-bottom: 15px;\">\n"
"                    <label style=\"display: block; margin-bottom: 8px; color: #aaa;\">Output State:</label>\n"
"                    <select id=\"chStateSelect\" onchange=\"onStateSelectChange()\" \n"
"                            style=\"padding: 10px 15px; background: #1a1a2e; border: 2px solid #444; color: #fff; border-radius: 4px; cursor: pointer; font-size: 14px; width: 150px;\">\n"
"                        <option value=\"0\">OFF</option>\n"
"                        <option value=\"1\">ON (100%%)</option>\n"
"                        <option value=\"6\">PWM</option>\n"
"                    </select>\n"
"                </div>\n"
"                <!-- PWM Slider -->\n"
"                <div id=\"chPwmRow\" style=\"display: none; margin-bottom: 15px; align-items: center; gap: 10px;\">\n"
"                    <label style=\"color: #aaa; min-width: 50px;\">Duty:</label>\n"
"                    <input type=\"range\" id=\"chPwmSlider\" min=\"0\" max=\"100\" value=\"50\" \n"
"                           style=\"flex: 1; height: 25px; cursor: pointer;\" oninput=\"updateChPwmDisplay()\">\n"
"                    <span id=\"chPwmVal\" style=\"color: #0ff; min-width: 45px; text-align: right;\">50%</span>\n"
"                </div>\n"
"                <!-- Load Resistance -->\n"
"                <div style=\"display: flex; align-items: center; gap: 10px; margin-bottom: 15px;\">\n"
"                    <label style=\"color: #aaa; min-width: 100px;\">Load (Ohms):</label>\n"
"                    <input type=\"number\" id=\"chLoadInput\" value=\"10\" min=\"0.001\" max=\"100000\" step=\"0.1\"\n"
"                           style=\"flex: 1; padding: 8px; background: #0a2540; border: 1px solid #444; color: #fff; border-radius: 4px;\">\n"
"                </div>\n"
"                <!-- Fault Status -->\n"
"                <div style=\"margin-bottom: 15px;\">\n"
"                    <span id=\"chFaultStatus\" style=\"color: #5f5;\">No fault</span>\n"
"                </div>\n"
"                <!-- Fault Injection -->\n"
"                <div style=\"margin-bottom: 15px;\">\n"
"                    <label style=\"display: block; margin-bottom: 8px; color: #aaa;\">Inject Fault:</label>\n"
"                    <div style=\"display: flex; gap: 8px; flex-wrap: wrap;\">\n"
"                        <button class=\"btn small\" onclick=\"injectFault(1)\" style=\"background: #a55;\">OC</button>\n"
"                        <button class=\"btn small\" onclick=\"injectFault(2)\" style=\"background: #a55;\">OT</button>\n"
"                        <button class=\"btn small\" onclick=\"injectFault(4)\" style=\"background: #a55;\">SC</button>\n"
"                        <button class=\"btn small\" onclick=\"injectFault(8)\" style=\"background: #a55;\">OL</button>\n"
"                        <button class=\"btn small\" onclick=\"clearChFault()\" style=\"background: #585;\">Clear</button>\n"
"                    </div>\n"
"                </div>\n"
"            </div>\n"
"            <div style=\"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;\">\n"
"                <button class=\"btn\" onclick=\"closeChannelModal()\">Cancel</button>\n"
"                <button class=\"btn primary\" onclick=\"applyChannelSettings()\">Apply</button>\n"
"            </div>\n"
"        </div>\n"
"    </div>\n"
"    \n"
"    <!-- Analog Input Dialog -->\n"
"    <div class=\"modal\" id=\"analogModal\">\n"
"        <div class=\"modal-content\" style=\"width: 350px;\">\n"
"            <div class=\"modal-header\">\n"
"                <h3 id=\"analogModalTitle\">AIN1</h3>\n"
"                <button class=\"modal-close\" onclick=\"closeAnalogModal()\">&times;</button>\n"
"            </div>\n"
"            <div style=\"padding: 15px 0;\">\n"
"                <div style=\"display: flex; align-items: center; gap: 15px; margin-bottom: 20px;\">\n"
"                    <input type=\"range\" id=\"analogSlider\" min=\"0\" max=\"3.3\" step=\"0.01\" value=\"0\" \n"
"                           style=\"flex: 1; height: 30px; cursor: pointer;\" \n"
"                           oninput=\"updateAnalogValue()\">\n"
"                    <span id=\"analogValue\" style=\"font-size: 1.5em; color: #0ff; min-width: 70px; text-align: right;\">0.00V</span>\n"
"                </div>\n"
"                <div style=\"display: flex; gap: 10px; justify-content: center;\">\n"
"                    <button class=\"btn small\" onclick=\"setAnalogPreset(0)\">0V</button>\n"
"                    <button class=\"btn small\" onclick=\"setAnalogPreset(1.65)\">1.65V</button>\n"
"                    <button class=\"btn small\" onclick=\"setAnalogPreset(2.5)\">2.5V</button>\n"
"                    <button class=\"btn small\" onclick=\"setAnalogPreset(3.3)\">3.3V</button>\n"
"                </div>\n"
"            </div>\n"
"            <div style=\"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;\">\n"
"                <button class=\"btn\" onclick=\"closeAnalogModal()\">Close</button>\n"
"                <button class=\"btn primary\" onclick=\"applyAnalogValue()\">Apply</button>\n"
"            </div>\n"
"        </div>\n"
"    </div>\n"
"</body>\n"
"</html>\n";

#endif /* EMU_WEBUI_HTML_H */
