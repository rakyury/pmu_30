# Задачи по совместимости с Ecumaster PMU

**Создано:** 2025-12-26
**Статус:** В работе

---

## Приоритет 1: Критично для совместимости

### TASK-001: Поддержка CAN клавиатур Ecumaster
**Статус:** TODO
**Сложность:** Средняя
**Файлы:** `firmware/src/pmu_ecumaster_keypad.c/h`, `configurator/src/ui/dialogs/ecumaster_keypad_dialog.py`

**Описание:**
Добавить поддержку CAN клавиатур Ecumaster (4, 6, 8, 12 кнопок).

**Требования:**
- [ ] CAN ID: 0x18EF5500 (J1939 extended)
- [ ] Поддержка до 2 клавиатур одновременно
- [ ] Чтение состояния кнопок (pressed/released)
- [ ] Обработка long-press, double-click
- [ ] LED управление (если поддерживается)

**Протокол Ecumaster:**
```
CAN ID: 0x18EF5500 (extended)
DLC: 8
Byte 0: Keypad ID (0 or 1)
Byte 1-2: Button states (bitmask)
Byte 3-7: Reserved
```

---

### TASK-002: Увеличить лимит CAN Message Objects до 100
**Статус:** TODO
**Сложность:** Низкая
**Файлы:** `firmware/include/pmu_can.h`, `firmware/src/pmu_can.c`

**Описание:**
Увеличить MAX_CAN_MESSAGES с 32 до 100 для совместимости с Ecumaster.

**Требования:**
- [ ] Изменить `#define MAX_CAN_MESSAGES 32` на `100`
- [ ] Проверить потребление памяти
- [ ] Обновить документацию
- [ ] Обновить валидацию в конфигураторе

---

### TASK-003: Delayed Turn Off
**Статус:** TODO
**Сложность:** Средняя
**Файлы:** `firmware/src/pmu_power.c/h`, `configurator/src/ui/dialogs/system_settings_dialog.py`

**Описание:**
Добавить функцию задержки выключения устройства после снятия питания +12V SW.

**Требования:**
- [ ] Настраиваемая задержка (0-300 секунд)
- [ ] Сохранение логов перед выключением
- [ ] Корректное завершение CAN коммуникации
- [ ] Индикация режима ожидания (LED)

---

### TASK-004: Autosaved Channels
**Статус:** TODO
**Сложность:** Средняя
**Файлы:** `firmware/src/pmu_config_storage.c`, `firmware/src/pmu_channel.c`

**Описание:**
Добавить возможность сохранения значений каналов при перезагрузке.

**Требования:**
- [ ] Флаг `autosave` для каналов Switch, Number
- [ ] Сохранение в EEPROM/Flash при изменении
- [ ] Восстановление значений при старте
- [ ] Защита от частой записи (debounce)
- [ ] UI для настройки autosave каналов

---

## Приоритет 2: Улучшения

### TASK-005: RTC с backup питанием
**Статус:** TODO
**Сложность:** Высокая (требует HW)
**Файлы:** `firmware/src/pmu_rtc.c/h`

**Описание:**
Добавить Real-Time Clock с суперконденсатором для backup (как в Ecumaster - до 3 дней).

**Требования:**
- [ ] Аппаратная поддержка RTC
- [ ] Backup питание (суперконденсатор)
- [ ] Синхронизация времени через CAN/USB
- [ ] Использование в логах

---

### TASK-006: Поддержка MoTeC/RaceGrade Keypad
**Статус:** TODO
**Сложность:** Средняя
**Файлы:** `firmware/src/pmu_motec_keypad.c/h`

**Описание:**
Добавить поддержку CAN клавиатур MoTeC/RaceGrade.

**Требования:**
- [ ] Определить CAN протокол MoTeC
- [ ] Поддержка 1 клавиатуры
- [ ] Чтение состояния кнопок
- [ ] LED управление

---

### TASK-007: Поддержка Grayhill Keypad
**Статус:** TODO
**Сложность:** Средняя
**Файлы:** `firmware/src/pmu_grayhill_keypad.c/h`

**Описание:**
Добавить поддержку CAN клавиатур Grayhill.

**Требования:**
- [ ] Определить CAN протокол Grayhill
- [ ] Поддержка 1 клавиатуры
- [ ] Ротационный энкодер (если есть)

---

### TASK-008: Low-Side Outputs (программная эмуляция)
**Статус:** TODO
**Сложность:** Низкая
**Файлы:** `firmware/src/pmu_profet.c`, `configurator/src/ui/dialogs/output_config_dialog.py`

**Описание:**
Добавить режим low-side для PROFET выходов (ограничение тока 1A).

**Требования:**
- [ ] Режим "Low-Side" с лимитом 1A
- [ ] Группировка до 3 выходов для PWM (как в Ecumaster AS)
- [ ] Предупреждение в UI о нестандартном использовании

---

### TASK-009: 12-bit ADC для входов 0-20V
**Статус:** TODO
**Сложность:** Средняя (требует HW проверки)
**Файлы:** `firmware/src/pmu_adc.c`

**Описание:**
Увеличить разрешение ADC для входов с расширенным диапазоном 0-20V.

**Требования:**
- [ ] Проверить возможности STM32H7 ADC
- [ ] Настройка oversampling для 12-bit
- [ ] Калибровка для 0-20V диапазона

---

### TASK-010: Multiple PMUs Support
**Статус:** TODO
**Сложность:** Высокая
**Файлы:** `firmware/src/pmu_multi.c/h`, `configurator/src/controllers/multi_device_controller.py`

**Описание:**
Добавить поддержку работы до 5 PMU устройств на одной CAN шине.

**Требования:**
- [ ] Уникальный Base ID для каждого устройства
- [ ] CANbus Export между PMU
- [ ] Конфигуратор с переключением между устройствами (Ctrl+Shift+1-5)
- [ ] Каналы pmuX.* для мониторинга

**Base ID (по Ecumaster):**
```
PMU-30_#1: 668
PMU-30_#2: 670 (или 678)
PMU-30_#3: 678 (или 688)
PMU-30_#4: 680
PMU-30_#5: 690
```

---

## Приоритет 3: Документация

### TASK-011: Документирование спецификаций
**Статус:** TODO
**Сложность:** Низкая
**Файлы:** `docs/PMU30_SPECIFICATIONS.md`

**Описание:**
Создать полную документацию спецификаций PMU-30.

**Требования:**
- [ ] Рабочий диапазон напряжений (6-22V?)
- [ ] Ток +5V выхода
- [ ] Reverse polarity protection
- [ ] Общий максимальный ток
- [ ] IP рейтинг
- [ ] Размеры и вес

---

## Статистика

| Приоритет | Всего | TODO | В работе | Готово |
|-----------|-------|------|----------|--------|
| P1 Критично | 4 | 4 | 0 | 0 |
| P2 Улучшения | 6 | 6 | 0 | 0 |
| P3 Документация | 1 | 1 | 0 | 0 |
| **Итого** | **11** | **11** | **0** | **0** |

---

## История изменений

| Дата | Изменение |
|------|-----------|
| 2025-12-26 | Создание документа на основе сравнения с Ecumaster PMU v101.1.5 |
